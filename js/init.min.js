(function() { var css = ".mnv-preloader-overlay{content:'';background:white;position:absolute;width:100%;height:100%;text-align:center;top:0;bottom:0;right:0;left:0}.mnv-preloader-loader,.mnv-preloader-loader:before,.mnv-preloader-loader:after{border-radius:50%}.mnv-preloader-loader:before,.mnv-preloader-loader:after{position:absolute;content:''}.mnv-preloader-loader:before{width:3.2em;height:8em;background:white;border-radius:6.2em 0 0 6.2em;top:-0.1em;left:-0.1em;-webkit-transform-origin:3.2em 3.1em;transform-origin:3.2em 3.1em;-webkit-animation:load2 2s infinite ease 1.5s;animation:load2 2s infinite ease 1.5s}.mnv-preloader-loader{font-size:13px;text-indent:-99999em;margin:3em auto;position:absolute;width:6em;height:6em;z-index:1;box-shadow:inset 0 0 0 1em #E3120B;left:50%;top:50%;margin-left:-3em;margin-top:-3em}.mnv-preloader-loader:after{width:3.2em;height:6.2em;background:white;border-radius:0 6.2em 6.2em 0;top:-0.1em;left:3.1em;-webkit-transform-origin:0px 3.1em;transform-origin:0px 3.1em;-webkit-animation:load2 2s infinite ease;animation:load2 2s infinite ease}@-webkit-keyframes load2{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes load2{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}[datatooltip]{position:relative;cursor:pointer;overflow:visible !important}[datatooltip]:before,[datatooltip]:after{visibility:hidden;opacity:0;pointer-events:none}[datatooltip]:before{position:absolute;top:-35px;right:50%;margin-right:-80px;margin-bottom:5px;padding:7px;width:160px;height:30px;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px;background-color:#000;background-color:#8b8b8b;color:#fff;content:attr(datatooltip);text-align:center;font-size:12px;line-height:1.2;box-sizing:border-box}label:last-of-type [datatooltip]:before{right:0}[datatooltip]:after{position:absolute;right:50%;width:0;top:-5px;border-top:5px solid #000;border-top:5px solid #8b8b8b;border-right:5px solid transparent;border-left:5px solid transparent;content:' ';font-size:0;line-height:0}[datatooltip]:hover:before,[datatooltip]:hover:after{visibility:visible;opacity:1;z-index:99999999999999}.not-highlight{background:initial;-webkit-transition:background 2000ms ease-out;-moz-transition:background 2000ms ease-out;-ms-transition:background 2000ms ease-out;-o-transition:background 2000ms ease-out;transition:background 2000ms ease-out}.highlight{background:#9cfcf2}.mnv-ec-livesearch{position:relative;font-family:EconSansCond;-webkit-font-smoothing:antialiased}.mnv-ec-livesearch ::-webkit-input-placeholder{color:#000}.mnv-ec-livesearch ::-moz-placeholder{color:#000}.mnv-ec-livesearch :-ms-input-placeholder{color:#000}.mnv-ec-livesearch :-moz-placeholder{color:#000}.mnv-ec-livesearch .mnv-ec-livesearch-input{box-sizing:border-box;border:none;background:#9cfcf2;height:30px;width:100%;padding:5px;padding-right:35px;padding-right:10px;font-size:14px;outline:none}.mnv-ec-livesearch .mnv-ec-livesearch-input:focus{background-color:#edeef0;color:#000}.mnv-ec-livesearch .mnv-ec-livesearch-reset{background:#333;background-repeat:no-repeat;background-position:50%;background-size:70%;border:none;height:100%;width:30px;position:absolute;height:100%;top:0px;right:0px;bottom:0px;padding:5px;outline:none}.mnv-ec-livesearch .mnv-ec-livesearch-reset.close{background-image:url("data:image/svg+xml;charset=US-ASCII,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!DOCTYPE%20svg%20PUBLIC%20%22-%2F%2FW3C%2F%2FDTD%20SVG%201.1%2F%2FEN%22%20%22http%3A%2F%2Fwww.w3.org%2FGraphics%2FSVG%2F1.1%2FDTD%2Fsvg11.dtd%22%3E%3Csvg%20version%3D%221.1%22%20id%3D%22Layer_1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20x%3D%220px%22%20y%3D%220px%22%20%20viewBox%3D%220%200%2056.69%2056.69%22%20enable-background%3D%22new%200%200%2056.69%2056.69%22%20xml%3Aspace%3D%22preserve%22%3E%3Cpath%20id%3D%22CIRCLE__x2F__DELETE_2_%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20fill%3D%22%23FFFFFF%22%20d%3D%22M28.25%2C55.5%20c-14.981%2C0-27.125-12.144-27.125-27.125C1.125%2C13.394%2C13.269%2C1.25%2C28.25%2C1.25s27.125%2C12.144%2C27.125%2C27.125%20C55.375%2C43.356%2C43.231%2C55.5%2C28.25%2C55.5z%20M28.25%2C6.336c-12.172%2C0-22.039%2C9.867-22.039%2C22.039c0%2C12.172%2C9.867%2C22.039%2C22.039%2C22.039%20s22.039-9.867%2C22.039-22.039C50.289%2C16.203%2C40.422%2C6.336%2C28.25%2C6.336z%20M37.574%2C40.242c-0.702%2C0-1.338-0.285-1.798-0.745l0%2C0%20l-7.526-7.526l-7.526%2C7.526l0%2C0c-0.46%2C0.46-1.096%2C0.745-1.798%2C0.745c-1.404%2C0-2.543-1.138-2.543-2.543%20c0-0.702%2C0.285-1.338%2C0.745-1.798l0%2C0l7.526-7.526l-7.526-7.526l0%2C0c-0.46-0.46-0.745-1.096-0.745-1.798%20c0-1.404%2C1.139-2.543%2C2.543-2.543c0.702%2C0%2C1.338%2C0.285%2C1.798%2C0.745l0%2C0l7.526%2C7.526l7.526-7.526l0%2C0%20c0.46-0.46%2C1.096-0.745%2C1.798-0.745c1.404%2C0%2C2.543%2C1.139%2C2.543%2C2.543c0%2C0.702-0.285%2C1.338-0.745%2C1.798l0%2C0l-7.526%2C7.526l7.526%2C7.526%20l0%2C0c0.46%2C0.46%2C0.745%2C1.096%2C0.745%2C1.798C40.117%2C39.104%2C38.979%2C40.242%2C37.574%2C40.242z%22%2F%3E%3C%2Fsvg%3E")}.mnv-ec-livesearch .mnv-ec-livesearch-reset.search{background-image:url("data:image/svg+xml;charset=US-ASCII,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!DOCTYPE%20svg%20PUBLIC%20%22-%2F%2FW3C%2F%2FDTD%20SVG%201.1%2F%2FEN%22%20%22http%3A%2F%2Fwww.w3.org%2FGraphics%2FSVG%2F1.1%2FDTD%2Fsvg11.dtd%22%3E%3Csvg%20version%3D%221.1%22%20id%3D%22Layer_1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20x%3D%220px%22%20y%3D%220px%22%20%20viewBox%3D%220%200%2056.69%2056.69%22%20enable-background%3D%22new%200%200%2056.69%2056.69%22%20xml%3Aspace%3D%22preserve%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M51.709%2C44.258l-8.83-8.831l-1.6-1.599c-0.064-0.064-0.139-0.108-0.205-0.169%20c1.719-2.966%2C2.719-6.401%2C2.719-10.076c0-11.127-9.02-20.146-20.147-20.146C12.519%2C3.437%2C3.5%2C12.456%2C3.5%2C23.583%20c0%2C11.127%2C9.019%2C20.146%2C20.146%2C20.146c3.611%2C0%2C6.993-0.963%2C9.924-2.627c0.068%2C0.078%2C0.121%2C0.165%2C0.195%2C0.239l1.6%2C1.599l8.83%2C8.831%20c1.979%2C1.977%2C5.184%2C1.977%2C7.16%2C0l0.354-0.354C53.686%2C49.44%2C53.686%2C46.235%2C51.709%2C44.258z%20M23.648%2C39.043%20c-8.539%2C0-15.463-6.919-15.463-15.46c0-8.54%2C6.924-15.461%2C15.463-15.461c8.538%2C0%2C15.458%2C6.921%2C15.458%2C15.461%20C39.105%2C32.124%2C32.186%2C39.043%2C23.648%2C39.043z%22%2F%3E%3C%2Fsvg%3E")}.mnv-ec-livesearch .mnv-ec-livesearch-reset:hover{background-color:#000;cursor:pointer}.mnv-ec-livesearch .mnv-ec-livesearch-list{position:absolute;top:30px;width:100%;max-height:85vh;overflow-y:auto;box-sizing:border-box}.mnv-ec-livesearch .mnv-ec-livesearch-list li{width:100%;background:#333;color:#fff;font-family:EconSansCond;padding:7px 5px;border-bottom:solid 1px #fff;box-sizing:border-box;font-size:14px;line-height:22px}.mnv-ec-livesearch .mnv-ec-livesearch-list li:hover{background-color:#07c5b2;color:#fff;cursor:pointer}ul.ec-interactive-dropdowns{list-style:none !important;margin:0 !important;padding:0;height:100%;width:100%;border-color:#d8d9da;border-style:solid;border-width:0 1px;border-right:none;border-left:none;display:-webkit-box;display:-moz-box;display:-ms-flexbox;display:-webkit-flex;display:flex;-webkit-box-direction:normal;-moz-box-direction:normal;-webkit-box-orient:horizontal;-moz-box-orient:horizontal;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:nowrap;-ms-flex-wrap:nowrap;flex-wrap:nowrap;-webkit-box-pack:start;-moz-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;-webkit-align-content:stretch;-ms-flex-line-pack:stretch;align-content:stretch;-webkit-box-align:start;-moz-box-align:start;-webkit-align-items:flex-start;-ms-flex-align:start;align-items:flex-start}.ec-interactive-dropdowns li{cursor:pointer;text-align:left;height:100%;box-sizing:border-box;float:left}.ec-interactive-dropdowns>li{position:relative;margin-bottom:0 !important;-webkit-box-ordinal-group:1;-moz-box-ordinal-group:1;-webkit-order:0;-ms-flex-order:0;order:0;-webkit-box-flex:1;-moz-box-flex:1;-webkit-flex:1 0 auto;-ms-flex:1 0 auto;flex:1 0 auto;-webkit-align-self:auto;-ms-flex-item-align:auto;align-self:auto}.ec-interactive-dropdowns>li.selected{border:0}.ec-interactive-dropdowns li.clicked{font-weight:bold;cursor:default}.ec-interactive-dropdowns li:not(:first-child){border-left:#d8d9da 1px solid}.ec-interactive-dropdowns>li.has-child:hover,.ec-interactive-dropdowns>li.has-nochild:hover{text-decoration:none}.ec-interactive-dropdowns>li.has-child:hover>span{background-position:95% 16px;border-bottom:#d8d9da 1px solid}.ec-interactive-dropdowns li.has-child ul{display:block;height:0;margin:0 !important;padding:0;position:absolute;top:41px;width:100%;height:auto}.ec-interactive-dropdowns>li.selected ul{border-top:1px solid #FFFFFF;top:40px}.ec-interactive-dropdowns li.has-child.show-menu ul,.ec-interactive-dropdowns .map-zoom.show-menu ul{z-index:9}.ec-interactive-dropdowns li.has-child ul li{background-color:#ffffff}.ec-interactive-dropdowns ul{z-index:1}.ec-interactive-dropdowns ul ul{z-index:2}.ec-interactive-dropdowns ul ul ul{z-index:3}.ec-interactive-dropdowns li.has-child ul li,.ec-interactive-dropdowns ul li{position:relative;z-index:0;text-align:center;width:100%;opacity:0;height:0;padding:0;transition:all .1s linear;-webkit-transition:all .2s linear;-moz-transition:all .1s linear;-o-transition:all .2s linear;border:0;font-size:12px;margin-bottom:0 !important;list-style-type:none;display:none}.ec-interactive-dropdowns li.show-menu>ul>li{height:39px;opacity:1;border-color:#d8d9da;border-style:solid;border-width:1px;display:block}.ec-interactive-dropdowns>ul>li.show-menu>ul>li{border-top:0}.ec-interactive-dropdowns>li.show-menu>ul>li:first-child{border-width:1px 1px 0 1px}.ec-interactive-dropdowns>li.show-menu ul li{margin-top:-1px}.ec-interactive-dropdowns>li.show-menu ul li:first-child{border-width:1px 1px 0 1px}.ec-interactive-dropdowns>li.show-menu ul li:first-child:last-child{border-width:1px}.ec-interactive-dropdowns li.show-menu{z-index:30}.ec-interactive-dropdowns li.show-menu{z-index:30}.ec-interactive-dropdowns li.has-child ul li:hover{background-color:#d8d9da}.ec-interactive-dropdowns li.show-menu li.has-child{position:relative}.ec-interactive-dropdowns li.show-menu li.has-child ul{position:absolute;left:100%;top:0px}.ec-interactive-dropdowns li.show-menu:last-child li.has-child ul{left:-100%}.ec-interactive-dropdowns .show-menu.has-child{background-color:#c1c1c1}.ec-interactive-dropdowns .show-menu.has-child .show-menu.has-child li:hover{background-color:#e7e7e7}.mnv-ec-storytiles .hero .mnv-map-uk-election-2017-election-night{float:none;max-width:none}.mnv-ec-storytiles .hero .mnv-map-uk-election-2017-election-night .title-main,.mnv-ec-storytiles .hero .mnv-map-uk-election-2017-election-night .title-fly{padding:0}.mnv-ec-storytiles .hero .mnv-map-uk-election-2017-election-night+.copy{display:none}@media only screen and (max-width: 980px) and (min-width: 633px){.mnv-ec-storytiles .hero .mnv-map-uk-election-2017-election-night{float:none !important;max-width:none !important}}@font-face{font-family:EconSansCond;font-weight:300;src:url(../font/econsanscndlig-webfont.woff2) format("woff2"),url(../font/econsanscndlig-webfont.woff) format("woff")}@font-face{font-family:EconSansCond;font-style:normal;src:url(../font/econsanscndreg-webfont.woff2) format("woff2"),url(../font/econsanscndreg-webfont.woff) format("woff")}@font-face{font-family:EconSansCond;font-weight:500;src:url(../font/econsanscndmed-webfont.woff2) format("woff2"),url(../font/econsanscndmed-webfont.woff) format("woff")}@font-face{font-family:EconSansCond;font-weight:700;src:url(../font/econsanscndbol-webfont.woff2) format("woff2"),url(../font/econsanscndbol-webfont.woff) format("woff")}.mnv-map-uk-election-2017-election-night{-webkit-font-smoothing:antialiased;max-width:961px;margin:auto;line-height:normal}.mnv-map-uk-election-2017-election-night [datatooltip]:before{background:#299c96;font-size:14px}.mnv-map-uk-election-2017-election-night [datatooltip]:after{border-top-color:#299c96}.mnv-map-uk-election-2017-election-night .toggle-views-back-to-uk{display:none}.mnv-map-uk-election-2017-election-night .constituency-info{display:none}.mnv-map-uk-election-2017-election-night .default-text-container{margin-bottom:10px;line-height:130%}.mnv-map-uk-election-2017-election-night.view-constituency .toggle-views-back-to-uk,.mnv-map-uk-election-2017-election-night.view-constituency .constituency-info{display:block}.mnv-map-uk-election-2017-election-night.view-constituency .default-text-container{display:none}.mnv-map-uk-election-2017-election-night.zoom-on .mappath-hover{stroke-width:0.2px !important}.mnv-map-uk-election-2017-election-night.zoom-on .toggler{pointer-events:none;opacity:0.2 !important}.mnv-map-uk-election-2017-election-night.zoom-on.map-hex .mappath-hover{stroke-width:1px !important}.mnv-map-uk-election-2017-election-night .update-box{display:none}.mnv-map-uk-election-2017-election-night .map-schematic,.mnv-map-uk-election-2017-election-night .map-linear{display:block;position:absolute;width:100%;height:100%;top:0;left:0;bottom:0}.mnv-map-uk-election-2017-election-night .map-linear{left:100%;z-index:2}.mnv-map-uk-election-2017-election-night .ukelmap-outer-wrapper{position:relative}.mnv-map-uk-election-2017-election-night .ukelmap-main-wrapper{text-align:left}.mnv-map-uk-election-2017-election-night .ukelmap-header-div{float:left;width:100%;height:auto;background-color:#EFEFEF}.mnv-map-uk-election-2017-election-night .ukelmap-topic-div{float:left;width:100%;background-color:#FFFFFF}.mnv-map-uk-election-2017-election-night .ukelmap-mainmap-div{float:left;width:100%;padding:0;overflow:hidden;position:relative;display:table-row;background:#fff}.mnv-map-uk-election-2017-election-night .ukelmap-footer-div{float:left;width:100%;background-color:#fff;font-size:0.8em;font-style:normal;line-height:3em;padding:0 1%;box-sizing:border-box;display:none}.mnv-map-uk-election-2017-election-night .redflash-div{background-color:#FF0000;float:left;width:1.5%;height:100%}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div{float:left;width:100%;height:100%;font-size:1.2em;font-weight:normal;line-height:1.8em;padding:10px;box-sizing:border-box}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div .title-main{color:#299c96;font-weight:100;line-height:30px;font-size:28px;display:inline;margin-right:10px}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div .title-fly{color:#333;font-weight:100;line-height:30px;font-size:28px;display:inline}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div .title-rubric{position:relative;overflow:hidden;font-weight:normal;font-size:18px;line-height:22px}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div .update-box{font-size:14px;line-height:16px;padding-bottom:5px}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div .update-label{position:relative}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div .update-label:after{content:' ';display:inline-block;width:4px;height:4px;background:#8b8b8b;border-radius:4px;position:absolute;top:50%;margin-top:-2px;right:-7px}.mnv-map-uk-election-2017-election-night .ukelmap-titlestring-div .update-time{color:red;margin-left:10px}.mnv-map-uk-election-2017-election-night .ukelmap-tree,.mnv-map-uk-election-2017-election-night .ukelmap-map-div,.mnv-map-uk-election-2017-election-night .ukelmap-keys-div{overflow:hidden;box-sizing:border-box}.mnv-map-uk-election-2017-election-night .ukelmap-tree,.mnv-map-uk-election-2017-election-night .ukelmap-map-div{display:table-cell;height:100%;min-width:30%;float:left}.mnv-map-uk-election-2017-election-night .ukelmap-tree{width:30%;overflow:visible}.mnv-map-uk-election-2017-election-night .ukelmap-map-div{width:45%}.mnv-map-uk-election-2017-election-night .mnv-ec-livesearch{z-index:9999;font-family:EconSansCond}.mnv-map-uk-election-2017-election-night .ukelmap-keys-div{width:25%}.mnv-map-uk-election-2017-election-night .ukelmap-keys-ul{float:left;width:100%;margin:0;padding:0;background-color:#FFFFFF;min-height:350px;position:relative}.mnv-map-uk-election-2017-election-night .ukelmap-keys-li{list-style:none;border-left-style:solid;border-left-width:3em;font-size:.8em;font-style:normal;text-align:left;margin-left:2%;margin-right:.5%;width:80%;height:20px;line-height:1.5em;text-transform:uppercase;-webkit-font-smoothing:antialiased;padding-left:5px;margin-bottom:1px;position:absolute;-webkit-transition:top 1s ease-in-out;-moz-transition:top 1s ease-in-out;-o-transition:top 1s ease-in-out;transition:top 1s ease-in-out}.mnv-map-uk-election-2017-election-night .key_0{top:0;z-index:20}.mnv-map-uk-election-2017-election-night .key_1{top:21px;z-index:19}.mnv-map-uk-election-2017-election-night .key_2{top:42px;z-index:18}.mnv-map-uk-election-2017-election-night .key_3{top:63px;z-index:17}.mnv-map-uk-election-2017-election-night .key_4{top:84px;z-index:16}.mnv-map-uk-election-2017-election-night .key_5{top:105px;z-index:15}.mnv-map-uk-election-2017-election-night .key_6{top:126px;z-index:14}.mnv-map-uk-election-2017-election-night .key_7{top:147px;z-index:13}.mnv-map-uk-election-2017-election-night .key_8{top:168px;z-index:12}.mnv-map-uk-election-2017-election-night .key_9{top:189px;z-index:1}.mnv-map-uk-election-2017-election-night .key_10{top:210px;z-index:10}.mnv-map-uk-election-2017-election-night .key_11{top:231px;z-index:9}.mnv-map-uk-election-2017-election-night .key_12{top:252px;z-index:8}.mnv-map-uk-election-2017-election-night .key_13{top:273px;z-index:7}.mnv-map-uk-election-2017-election-night .key_14{top:294px;z-index:6}.mnv-map-uk-election-2017-election-night .key_15{top:315px;z-index:5}.mnv-map-uk-election-2017-election-night .how-to-use{font-size:15px;color:#299c96;line-height:100%;margin-top:10px}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .domain{display:none}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .zero-line{stroke:black !important}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .ukel-cat-cons p{text-align:right}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .ukel-val-cons{fill:#9f0737 !important}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .ukel-val-cons,.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .ukel-val-nat{font-size:18px;font-family:EconSansCond;font-weight:700}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .ukel-cat-text-p{font-size:14px;font-family:EconSansCond;font-weight:700;-webkit-font-smoothing:antialiased}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .ukel-cat-cons .ukel-cat-text-p{color:#9f0737}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .ukel-val-nat{fill:#333333 !important}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .tick text{fill:#626262 !important}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div svg .tick line{stroke-width:0.5px;stroke:#000;stroke-dasharray:2 2;stroke-linecap:round}.mnv-map-uk-election-2017-election-night .ukelmap-colchart-div{height:300px;visibility:hidden}.mnv-map-uk-election-2017-election-night.tabs-pop .ukelmap-treemap-div,.mnv-map-uk-election-2017-election-night.tabs-pop .ukelmap-treechart,.mnv-map-uk-election-2017-election-night.tabs-pop .constituency-info,.mnv-map-uk-election-2017-election-night.tabs-hpr .ukelmap-treemap-div,.mnv-map-uk-election-2017-election-night.tabs-hpr .ukelmap-treechart,.mnv-map-uk-election-2017-election-night.tabs-hpr .constituency-info,.mnv-map-uk-election-2017-election-night.tabs-sal .ukelmap-treemap-div,.mnv-map-uk-election-2017-election-night.tabs-sal .ukelmap-treechart,.mnv-map-uk-election-2017-election-night.tabs-sal .constituency-info,.mnv-map-uk-election-2017-election-night.tabs-ele .ukelmap-treemap-div,.mnv-map-uk-election-2017-election-night.tabs-ele .ukelmap-treechart,.mnv-map-uk-election-2017-election-night.tabs-ele .constituency-info{display:none}.mnv-map-uk-election-2017-election-night.tabs-pop .ukelmap-treetext-top .default-text-container,.mnv-map-uk-election-2017-election-night.tabs-pop .ukelmap-treechart,.mnv-map-uk-election-2017-election-night.tabs-hpr .ukelmap-treetext-top .default-text-container,.mnv-map-uk-election-2017-election-night.tabs-hpr .ukelmap-treechart,.mnv-map-uk-election-2017-election-night.tabs-sal .ukelmap-treetext-top .default-text-container,.mnv-map-uk-election-2017-election-night.tabs-sal .ukelmap-treechart,.mnv-map-uk-election-2017-election-night.tabs-ele .ukelmap-treetext-top .default-text-container,.mnv-map-uk-election-2017-election-night.tabs-ele .ukelmap-treechart{display:block}.mnv-map-uk-election-2017-election-night.tabs-pop .default-text-container,.mnv-map-uk-election-2017-election-night.tabs-hpr .default-text-container,.mnv-map-uk-election-2017-election-night.tabs-sal .default-text-container,.mnv-map-uk-election-2017-election-night.tabs-ele .default-text-container{color:#535353;font-size:18px;font-family:EconSansCond;font-weight:700;padding-top:55px !important;line-height:120%;padding-bottom:20px}.mnv-map-uk-election-2017-election-night.tabs-pop .ukelmap-colchart-div,.mnv-map-uk-election-2017-election-night.tabs-hpr .ukelmap-colchart-div,.mnv-map-uk-election-2017-election-night.tabs-sal .ukelmap-colchart-div,.mnv-map-uk-election-2017-election-night.tabs-ele .ukelmap-colchart-div{visibility:visible}.mnv-map-uk-election-2017-election-night.tabs-pop .ukelmap-keys-label,.mnv-map-uk-election-2017-election-night.tabs-hpr .ukelmap-keys-label,.mnv-map-uk-election-2017-election-night.tabs-sal .ukelmap-keys-label,.mnv-map-uk-election-2017-election-night.tabs-ele .ukelmap-keys-label{padding-right:10px;line-height:120%}.mnv-map-uk-election-2017-election-night .ukelmap-treetext-top{margin-bottom:10px}.mnv-map-uk-election-2017-election-night .ukelmap-treetext-top,.mnv-map-uk-election-2017-election-night .ukelmap-treechart,.mnv-map-uk-election-2017-election-night .ukelmap-treetext-bottom{float:left;width:100%;background-color:#FFFFFF}.mnv-map-uk-election-2017-election-night .ukelmap-treechart{height:33%}.mnv-map-uk-election-2017-election-night .ukelmap-treemap-div{background-color:#ffffff;position:relative;width:100%;height:100%}.mnv-map-uk-election-2017-election-night .ukelmap-treemap-node{border:none;fill:none;background-color:red;line-height:0.95;overflow:hidden;position:absolute;border-radius:0;color:#fff;text-indent:2px;line-height:20px;font-size:14px;font-weight:bold;cursor:default}.mnv-map-uk-election-2017-election-night .info-div{border:1px solid #FF0000;top:20%;left:25%;position:absolute;overflow:hidden;background-color:#FFFFFF;padding:1%;font-size:.9em;visibility:hidden}.mnv-map-uk-election-2017-election-night .info-div:first-line{font-size:1.1em;font-weight:bold}.mnv-map-uk-election-2017-election-night .info-div-show{visibility:visible}.mnv-map-uk-election-2017-election-night .toggle-div{position:absolute;top:75px;left:370px;height:20px;width:70px}.mnv-map-uk-election-2017-election-night .toggle-input{float:left;width:100%;height:100%;border-radius:0}.mnv-map-uk-election-2017-election-night .source-div,.mnv-map-uk-election-2017-election-night .footnote-div{float:left;width:30%;height:100%;padding-top:1%;line-height:1em}.mnv-map-uk-election-2017-election-night .footnote-div{text-align:right;width:69%}.mnv-map-uk-election-2017-election-night .ocean{fill:#FFFFFF;pointer-events:all}.mnv-map-uk-election-2017-election-night #mappaths{fill:#aaa;stroke-linejoin:miter;stroke-linecap:butt;stroke-miterlimit:2}.mnv-map-uk-election-2017-election-night .mappath{stroke:#cccccc;stroke-width:.5px;cursor:pointer}.mnv-map-uk-election-2017-election-night .mappath-hover,.mnv-map-uk-election-2017-election-night .blob-hover{stroke:#00ff64;fill:none;background-color:none}.mnv-map-uk-election-2017-election-night .chartheaders-div{position:absolute;pointer-events:none;top:0;height:20%;width:100%;background-color:#FFFFFF}.mnv-map-uk-election-2017-election-night .charttitle-div,.mnv-map-uk-election-2017-election-night .chartsubtitle-div{float:left;width:100%;height:50%;font-size:1.25em;font-weight:bold;line-height:2em;padding-left:5px}.mnv-map-uk-election-2017-election-night .chartsubtitle-div{font-size:1em;font-weight:normal}.mnv-map-uk-election-2017-election-night .infobox-div{position:absolute;pointer-events:none;top:20%;height:30%;width:20%;background-color:#FF0000;border:1px solid #ccc;font-size:.9em;line-height:1em;padding:2% 1%}.mnv-map-uk-election-2017-election-night .pointer-events-none{pointer-events:none}.mnv-map-uk-election-2017-election-night .hide{display:none;transition:all 1s ease}.mnv-map-uk-election-2017-election-night .ukelmap-map-div svg{overflow:hidden}.mnv-map-uk-election-2017-election-night .toggle-views-btn{text-transform:uppercase;font-size:12px;padding:10px;background:#edeef0;color:#545454;border:none;margin:10px 5px 10px 0;width:100px;outline:none}.mnv-map-uk-election-2017-election-night .toggle-views-btn:hover{background:#000;color:#fff;cursor:pointer}.mnv-map-uk-election-2017-election-night .closer{display:none;background-image:url("data:image/svg+xml;charset=US-ASCII,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%3C!DOCTYPE%20svg%20PUBLIC%20%22-%2F%2FW3C%2F%2FDTD%20SVG%201.1%2F%2FEN%22%20%22http%3A%2F%2Fwww.w3.org%2FGraphics%2FSVG%2F1.1%2FDTD%2Fsvg11.dtd%22%3E%3Csvg%20version%3D%221.1%22%20id%3D%22Layer_1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20x%3D%220px%22%20y%3D%220px%22%20%20viewBox%3D%220%200%2056.69%2056.69%22%20enable-background%3D%22new%200%200%2056.69%2056.69%22%20xml%3Aspace%3D%22preserve%22%3E%3Cpath%20id%3D%22CIRCLE__x2F__DELETE_2_%22%20fill-rule%3D%22evenodd%22%20clip-rule%3D%22evenodd%22%20fill%3D%22%23FFFFFF%22%20d%3D%22M28.25%2C55.5%20c-14.981%2C0-27.125-12.144-27.125-27.125C1.125%2C13.394%2C13.269%2C1.25%2C28.25%2C1.25s27.125%2C12.144%2C27.125%2C27.125%20C55.375%2C43.356%2C43.231%2C55.5%2C28.25%2C55.5z%20M28.25%2C6.336c-12.172%2C0-22.039%2C9.867-22.039%2C22.039c0%2C12.172%2C9.867%2C22.039%2C22.039%2C22.039%20s22.039-9.867%2C22.039-22.039C50.289%2C16.203%2C40.422%2C6.336%2C28.25%2C6.336z%20M37.574%2C40.242c-0.702%2C0-1.338-0.285-1.798-0.745l0%2C0%20l-7.526-7.526l-7.526%2C7.526l0%2C0c-0.46%2C0.46-1.096%2C0.745-1.798%2C0.745c-1.404%2C0-2.543-1.138-2.543-2.543%20c0-0.702%2C0.285-1.338%2C0.745-1.798l0%2C0l7.526-7.526l-7.526-7.526l0%2C0c-0.46-0.46-0.745-1.096-0.745-1.798%20c0-1.404%2C1.139-2.543%2C2.543-2.543c0.702%2C0%2C1.338%2C0.285%2C1.798%2C0.745l0%2C0l7.526%2C7.526l7.526-7.526l0%2C0%20c0.46-0.46%2C1.096-0.745%2C1.798-0.745c1.404%2C0%2C2.543%2C1.139%2C2.543%2C2.543c0%2C0.702-0.285%2C1.338-0.745%2C1.798l0%2C0l-7.526%2C7.526l7.526%2C7.526%20l0%2C0c0.46%2C0.46%2C0.745%2C1.096%2C0.745%2C1.798C40.117%2C39.104%2C38.979%2C40.242%2C37.574%2C40.242z%22%2F%3E%3C%2Fsvg%3E");background-repeat:no-repeat;background-size:80%;background-position:50%}.mnv-map-uk-election-2017-election-night .toggle-views-back-to-uk{background:#333;color:#fff}.mnv-map-uk-election-2017-election-night.version-small .hide-on-small{display:none}.mnv-map-uk-election-2017-election-night.version-small svg{margin-top:10px}.mnv-map-uk-election-2017-election-night.version-small .ukelmap-mainmap-div{display:block;height:550px}.mnv-map-uk-election-2017-election-night.version-small .ukelmap-tree{display:none}.mnv-map-uk-election-2017-election-night.version-small .ukelmap-tree{width:100%}.mnv-map-uk-election-2017-election-night.version-small .ukelmap-topic-div .ec-interactive-dropdowns li{max-width:50%}.mnv-map-uk-election-2017-election-night.version-small .ukelmap-topic-div .ec-interactive-dropdowns li:nth-child(1n+3){display:none}.mnv-map-uk-election-2017-election-night.version-small .ukelmap-map-div{width:100%;display:block;padding:0px;box-sizing:border-content}.mnv-map-uk-election-2017-election-night.version-small .title-fly{display:block;margin-bottom:10px}.mnv-map-uk-election-2017-election-night.version-small .title-rubric{color:#545454;display:none}.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch{margin-top:5px}.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-input,.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-reset{height:40px}.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-reset{width:40px}.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-list{top:40px}.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-input,.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-list li{font-size:16px}.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-input{padding-left:10px}.mnv-map-uk-election-2017-election-night.version-small .toggle-views-back-to-uk{display:inline}.mnv-map-uk-election-2017-election-night.version-small .mnv-ec-livesearch .mnv-ec-livesearch-list{max-height:400px}.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-map-div .toggle-views-btn.toggle-views-key{width:auto}.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div{position:absolute;top:50px;right:0;box-sizing:content-box;width:auto;margin-right:10px;bottom:0px;margin-right:0;margin-left:0;white-space:nowrap;padding:0 5px 0 0;width:150px}.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-label{display:none}.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-ul{min-height:10px !important;margin-top:5px}.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li{display:none}.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li.key_0,.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li.key_1,.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li.key_2,.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li.key_3,.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li.key_4,.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li.key_5{display:block}@media screen and (max-width: 400px){.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div{width:100px}.mnv-map-uk-election-2017-election-night.version-small:not(.view-key) .ukelmap-keys-div .ukelmap-keys-li{border-left-width:0.5em;font-size:11px}}.mnv-map-uk-election-2017-election-night.version-small.view-key .ukelmap-keys-ul{padding:10px;box-sizing:border-box;border-radius:0 0 12px 12px}.mnv-map-uk-election-2017-election-night.version-small.view-key .ukelmap-keys-label{border-radius:12px 12px 0 0;background-color:#fff;padding:10px;padding-left:20px}.mnv-map-uk-election-2017-election-night.version-small.view-key .ukelmap-keys-div{position:fixed;top:0;left:0;width:100%;height:100%;display:block;z-index:10000;border:solid 1px #8b8b8b;padding:20px;box-sizing:border-box;background:rgba(0,0,0,0.7);display:block !important}.mnv-map-uk-election-2017-election-night.version-small.view-key .ukelmap-keys-div .closer{position:absolute;display:block;top:0;right:0px;outline:none;background-color:black;width:40px;height:40px;border-radius:20px;border:none;cursor:pointer}.mnv-map-uk-election-2017-election-night.version-small .ukelmap-map-div .toggle-views-key{margin-left:10px}.mnv-map-uk-election-2017-election-night.version-small.view-constituency .ukelmap-map-div .toggle-views-key{display:none !important}.mnv-map-uk-election-2017-election-night.version-small.view-constituency .ukelmap-map-div svg,.mnv-map-uk-election-2017-election-night.version-small.view-constituency .ukelmap-keys-div{display:none}.mnv-map-uk-election-2017-election-night.version-small.view-constituency .ukelmap-tree{display:block;padding-left:10px;padding-right:10px;order:3}.mnv-map-uk-election-2017-election-night.version-small.view-constituency .ukelmap-mainmap-div{display:flex;flex-direction:column}.mnv-map-uk-election-2017-election-night.version-small.view-constituency .ukelmap-map-div{overflow:visible;height:auto}.mnv-map-uk-election-2017-election-night.version-small.view-constituency .ukelmap-tree{display:block}.mnv-map-uk-election-2017-election-night.version-small .toggler{display:none}.mnv-map-uk-election-2017-election-night.version-small .toggle-views{display:block}.mnv-map-uk-election-2017-election-night.version-small .toggle-views-back-to-uk{display:inline-block}.mnv-map-uk-election-2017-election-night.version-big .hide-on-big{display:none}.mnv-map-uk-election-2017-election-night.version-big .mnv-ec-livesearch-list{max-height:450px}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-mainmap-div{height:550px;overflow:visible}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-footer-div{border-bottom:dashed 1px #8b8b8b}.mnv-map-uk-election-2017-election-night.version-big .mnv-ec-livesearch{width:53%;float:right;position:absolute;left:102%}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-keys-label{margin-bottom:10px}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-mainmap-div{padding-top:20px;padding-bottom:20px}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-map-div{overflow:visible;position:relative}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-tree,.mnv-map-uk-election-2017-election-night.version-big .ukelmap-map-div,.mnv-map-uk-election-2017-election-night.version-big .ukelmap-keys-div{padding:0 0 0 10px}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-keys-div{padding-left:0}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-keys-li{margin-left:0}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-keys-div{padding-top:50px;padding-left:10px}.mnv-map-uk-election-2017-election-night.version-big .toggler-container{display:table-row;margin-bottom:10px;float:left}.mnv-map-uk-election-2017-election-night.version-big .toggle-views,.mnv-map-uk-election-2017-election-night.version-big .toggler{display:table-cell;vertical-align:top}.mnv-map-uk-election-2017-election-night.version-big .toggle-views-back-to-uk{margin-top:0;margin-bottom:0;padding:0;height:30px}.mnv-map-uk-election-2017-election-night.version-big .toggle-views-key{display:none}.mnv-map-uk-election-2017-election-night.version-big .constituency-info{margin-top:10px}@media screen and (max-width: 900px){.mnv-map-uk-election-2017-election-night.version-big .ec-interactive-dropdowns li{width:auto}.mnv-map-uk-election-2017-election-night.version-big .default-text-container{margin-bottom:0px;padding-top:0px;line-height:110%}}@media screen and (max-width: 700px){.mnv-map-uk-election-2017-election-night.version-big .ukelmap-tree{width:40%}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-map-div{width:35%}.mnv-map-uk-election-2017-election-night.version-big .mnv-ec-livesearch{width:70%}.mnv-map-uk-election-2017-election-night.version-big .ukelmap-keys-div{width:25%}.mnv-map-uk-election-2017-election-night.version-big .constituency-info{font-size:16px !important}}.mnv-map-uk-election-2017-election-night .ec-interactive-dropdowns{border-bottom:solid 4px #07c5b2;background:#000;box-sizing:border-box}.mnv-map-uk-election-2017-election-night .ec-interactive-dropdowns li{background:#000;padding:10px;font-size:18px;line-height:18px;color:#a0aaaa;background:#333;overflow:hidden}.mnv-map-uk-election-2017-election-night .ec-interactive-dropdowns li span{white-space:nowrap}.mnv-map-uk-election-2017-election-night .ec-interactive-dropdowns li:hover{background-color:#000;color:white}.mnv-map-uk-election-2017-election-night .ec-interactive-dropdowns li.selected{background-color:#07c5b2;color:white}.mnv-map-uk-election-2017-election-night .constituency-info,.mnv-map-uk-election-2017-election-night .default-header,.mnv-map-uk-election-2017-election-night .default-subheader{font-size:18px;text-transform:uppercase;color:#545454}.mnv-map-uk-election-2017-election-night .default-header{font-weight:bold;padding-bottom:5px}.mnv-map-uk-election-2017-election-night .default-subheader{padding-bottom:5px}.mnv-map-uk-election-2017-election-night .constituency{font-weight:bold}.mnv-map-uk-election-2017-election-night .party,.mnv-map-uk-election-2017-election-night .turnout{border-bottom:dashed 1px #8b8b8b;padding-bottom:5px;margin-bottom:5px}.mnv-map-uk-election-2017-election-night .party-name{font-weight:bold}.mnv-map-uk-election-2017-election-night .party-status{font-weight:bold;margin-left:10px;color:#07c5b2}.mnv-map-uk-election-2017-election-night .mp,.mnv-map-uk-election-2017-election-night .majority,.mnv-map-uk-election-2017-election-night .swing,.mnv-map-uk-election-2017-election-night .turnout{margin-bottom:10px}.mnv-map-uk-election-2017-election-night .mp-name,.mnv-map-uk-election-2017-election-night .majority-label,.mnv-map-uk-election-2017-election-night .swing-label,.mnv-map-uk-election-2017-election-night .turnout-label,.mnv-map-uk-election-2017-election-night .mp-values,.mnv-map-uk-election-2017-election-night .majority-values,.mnv-map-uk-election-2017-election-night .swing-values,.mnv-map-uk-election-2017-election-night .turnout-values{line-height:100%;box-sizing:border-box;display:table-cell}.mnv-map-uk-election-2017-election-night .mp-name,.mnv-map-uk-election-2017-election-night .majority-label,.mnv-map-uk-election-2017-election-night .swing-label,.mnv-map-uk-election-2017-election-night .turnout-label{width:60%;max-width:60%}.mnv-map-uk-election-2017-election-night .mp-values,.mnv-map-uk-election-2017-election-night .majority-values,.mnv-map-uk-election-2017-election-night .swing-values,.mnv-map-uk-election-2017-election-night .turnout-values{width:20%;min-width:120px}.mnv-map-uk-election-2017-election-night .majority,.mnv-map-uk-election-2017-election-night .swing,.mnv-map-uk-election-2017-election-night .turnout{color:#8b8b8b}.mnv-map-uk-election-2017-election-night .party-lib-dem{color:yellow}.toggler-container{width:100%}.toggler-container .toggler{width:80px;background-color:#edeef0;margin-bottom:10px}.toggler-container .toggler .tgl{display:none}.toggler-container .toggler .tgl,.toggler-container .toggler .tgl:after,.toggler-container .toggler .tgl:before,.toggler-container .toggler .tgl *,.toggler-container .toggler .tgl *:after,.toggler-container .toggler .tgl *:before,.toggler-container .toggler .tgl+.tgl-btn{box-sizing:border-box}.toggler-container .toggler .tgl::selection,.toggler-container .toggler .tgl:after::selection,.toggler-container .toggler .tgl:before::selection,.toggler-container .toggler .tgl *::selection,.toggler-container .toggler .tgl *:after::selection,.toggler-container .toggler .tgl *:before::selection,.toggler-container .toggler .tgl+.tgl-btn::selection{background:none}.toggler-container .toggler .tgl+.tgl-btn{outline:0;display:block;width:80px;height:30px;position:relative;cursor:pointer;user-select:none}.toggler-container .toggler .tgl+.tgl-btn:after,.toggler-container .toggler .tgl+.tgl-btn:before{position:relative;display:block;content:'';width:50%;height:100%}.toggler-container .toggler .tgl+.tgl-btn:after{left:0}.toggler-container .toggler .tgl+.tgl-btn:before{display:none}.toggler-container .toggler .toggler-btn+.tgl-btn{backface-visibility:hidden;transition:all .2s ease;font-family:sans-serif}.toggler-container .toggler .toggler-btn+.tgl-btn:after,.toggler-container .toggler .toggler-btn+.tgl-btn:before{display:inline-block;transition:all .2s ease;width:40px;text-align:center;position:absolute;line-height:40px;font-weight:bold;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,0.4);padding:2px;box-sizing:border-box}.toggler-container .toggler .toggler-btn+.tgl-btn:after,.toggler-container .toggler .toggler-btn+.tgl-btn:before{content:'';background-repeat:no-repeat;background-size:100%}.toggler-container .toggler .toggler-btn+.tgl-btn:after{left:50%;background-image:url(data:image/png;base64,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);background-color:#545454;opacity:0.5}.toggler-container .toggler .toggler-btn+.tgl-btn:before{left:0;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAEsCAYAAADtt+XCAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEwAACxMBAJqcGAAAIABJREFUeJzt3XmY5FV5L/B3qVkYGJhhGWAGEBlQIRGJBlC5UdwFl+gNGpAkBjUuMUY0QeOeRB9NYmLIFWOUaFBzI5pr3KOCokTFFRERFAFlH5itZ+uZ7unzft/7RxfJOPRS3V1Vp5bv53nmeaDrV7/zrZrpeuv8zu+cI0JEREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREtHAAHhgR/y8zn1M7CxER9QkAj46InZmZpZTtEfGPtTMREVGPy8xGKWU091BKGYuIv6idjYiIelhEfD6nUEq5NTMbtfMR9RKrHYCoVwA4TkQeNdVjqjouIuhuIqLexgJC1JSZb8vMFdM8/FVVZQEhIqJfBuC4UsptU12+iohdAPapnZGIiHpQRNxbSsEUYx/bAby5dj6iXqS1AxDNJjMPzsxjpXnJVVXvVtVb23X+iPhiZp7s7gfu/RiAn7n7g9vVFhERdUFm/q+I+FIpZUNmbimljJZSRiJiU0TcExGfBvAqAKdl5qI5nnsZgAsiYsPExMT6aS5dbcjMYzr1+oj6HXsg1JMAvDEzX2pma2Y5bpuI7BSR/TPzZlXdLCI/V9XbReRuVf1FZi4XkYNV9SAAB4vIMjN7HoARMzt6qvNGxC4ze4eZvbXNL41oYLCAUM+JiL/IzAvcfd4D1xGxS0TGRGRCVVVEkJmLVHW5mc3aW4mIX5jZyWa2ab4ZiIioiwC8Yu+Z4DU0lzLhbe5EM2APhFoG4EkicpSZfaBD51+bmT8ws/07cf45ZhmZalCdiIjmAMCvRcQ1EbFuYmJia0Rc24l2SilX1u553CcivtKJ10hENDQAvKyUcs+eH64TExMB4I1tbufkUsqOWgVjT6WU7cll3ImI5i8z/zwzt0z1IRsR/9XOtpp7b/SEiPhmO18bEdFQAfD8iNg2w4fst9vZ3n37b9QWETsyc2U7XxvRoOJdJnQ/AM4HcJGZLZ/hsB+1sb1ni0j1pdIBjKrqs1V1pHYW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);background-color:#07c5b2;opacity:1}.map-hex #map-toggler+.tgl-btn:before{background-color:#545454;opacity:0.5}.map-hex #map-toggler+.tgl-btn:after{background-color:#07c5b2;opacity:1}\n" + 
"\n", head = document.getElementsByTagName('head')[0], style = document.createElement('style'); style.setAttribute('type', 'text/css'); var nodeStyle = document.createTextNode(css); if(style.styleSheet){ style.styleSheet.cssText = css;}else{ style.appendChild(nodeStyle); }; head.appendChild(style);})();
d3.jsonp = function (url, callback) {
  function rand() {
    var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
      c = '', i = -1;
    while (++i < 15) c += chars.charAt(Math.floor(Math.random() * 52));
    return c;
  }

  function create(url) {
    var e = url.match(/callback=d3.jsonp.(\w+)/),
      c = e ? e[1] : rand();
    d3.jsonp[c] = function(data) {
      callback(data);
      delete d3.jsonp[c];
      script.remove();
    };
    return 'd3.jsonp.' + c;
  }

  var cb = create(url),
    script = d3.select('head')
    .append('script')
    .attr('type', 'text/javascript')
    .attr('src', url.replace(/(\{|%7B)callback(\}|%7D)/, cb));
};

"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

// CONTROLLER
mnv_ukelmap.model = (function(){
  var my, windoeThreshold, flags;

  my = {};

  // WINDOW THRESHOLD
  //    threshold is value in px below which we draw 'small'
  //    small is reset to true if width < threshold
  //    Initially, I'm setting threshold implausibly small, so that the flag is never tripped...
  my.windowThreshold = {
    threshold: 595,
    small: false
  };

  // FLAGS
  // flags is an object defining all properties that
  // the various components need to know...
  // (For components to 'update' at startup, local flags must be set to different default values)
  my.flags = {
    requestedconstit: undefined,
    currentconstit: undefined,
    constitavailable: false,
    dataindex: "fif",
    datapointindex: 0,
    freezechart: false,
    mapindex: 0,
    showinstructions: true,
    hexflag: true,
    zoomconstit: undefined,
    latestupdate: undefined,
    updatecounter: 0
  };

  // GO-LIVE TIME: 10pm on 8 June 2017 as ms
  // Note that months are from zero (so 5 for June)
  // And, since June is BST, subtract 1 from hour (i.e. 21 for 10pm)
  my.goliveTime = new Date(Date.UTC(2017, 5, 8, 21, 0, 0));
  // But for TESTING (4 = May; hour must be T-1)
  // my.goliveTime = Date.UTC(2017, 4, 9, 13, 45, 0);

  // COLOURS
  my.colours = {
    map: {
      default: '#DDDDDD'
    },
    undeclared: '#aaa',
    remain: '#5DA4DF',
    leave: '#C89608',
  };

  // DATA repository (filled by datafilter)
  my.data = {
    singleResults2010:{},
    singleResults2015:{},
    singleResults2017:{}
  };

  // KEYS
  // For election, only one element in the array (map never shifts from 0?)
  my.keys = {
    // 2017:
    "sev": {
      compare: "EQUAL",
      // LAYOUT sets key layout: number of rows and columns
      layout: {rows:5, columns:3},
      bigranges: [
        {id:'con'},
        {id:'lab'},
        {id:'lib'},
        {id:'dup'},
        {id:'snp'},
        {id:'snf'},
        {id:'ind'},
        {id:'plc'},
        {id:'sdl'},
        {id:'ukp'},
        {id:'grn'},
        {id:'res'},
        {id:'uup'},
        {id:'bnp'},
        {id:'oth'}
      ],
      smallranges: null,
      keyTitle: "Seats"
    },
    // 2015:
    "fif": {
      compare: "EQUAL",
      // LAYOUT sets key layout: number of rows and columns
      layout: {rows:5, columns:3},
      bigranges: [
        {id:'con'},
        {id:'lab'},
        {id:'lib'},
        {id:'dup'},
        {id:'snp'},
        {id:'snf'},
        {id:'ind'},
        {id:'plc'},
        {id:'sdl'},
        {id:'ukp'},
        {id:'grn'},
        {id:'res'},
        {id:'uup'},
        {id:'bnp'},
        {id:'oth'}
      ],
      smallranges: null,
      keyTitle: "Seats"
    },
    // 2010:
    "ten":{
      compare: "EQUAL",
      // LAYOUT sets key layout: number of rows and columns
      layout: {rows:5, columns:3},
      bigranges: [
        {id:'con'},
        {id:'lab'},
        {id:'lib'},
        {id:'dup'},
        {id:'snp'},
        {id:'snf'},
        {id:'ind'},
        {id:'plc'},
        {id:'sdl'},
        {id:'ukp'},
        {id:'grn'},
        {id:'res'},
        {id:'uup'},
        {id:'bnp'},
        {id:'oth'}
      ],
      smallranges: null,
      keyTitle: "Seats"
    },
    // BREXIT
    // Details to come, using old salaries for now
    "brx":{
      compare: "LESS-EQUAL",
      // LAYOUT sets key layout: number of rows and columns
      layout: {rows:5, columns:3},
      // Range values are for %-remain
      bigranges: [
        {val:30,fill:"#8D6300",display:"30 or less"},
        {val:40,fill:"#C89608",display:"30 to 40"},
        {val:50,fill:"#FFCB4D",display:"40 to 50"},
        {val:60,fill:"#98DAFF",display:"50 to 60"},
        {val:70,fill:"#5DA4DF",display:"60 to 70"},
        {val:1000,fill:"#00588D",display:"More than 70"}
      ],
      smallranges: null,
      keyTitle: "Percent 'Remain'"
    }
  };


  var version = '0.0.4';
  // SOURCE FOLDERS
  // Just locations; actual map and data files will be defined by topic
  my.sourcefiles = {
    // LITERAL PATHS are in my versioned folder
    literalpaths: "http://cdn.static-economist.com/sites/default/files/external/minerva_assets/ukel_map/test/" + version + "/ukliteralpaths.json",
    // CONSTITUENCY LOOKUPS of HEX LOCATIONS are in my versioned folder
    constituencylookupdata: "http://cdn.static-economist.com/sites/default/files/external/minerva_assets/ukel_map/test/" + version + "/constituencylookup.json",
    // ALEX'S LIVE FOLDERS
    // GLOBAL -- timestame, seats, and winners --
    results2010:        "http://cdn.static-economist.com/sites/default/files/external/minerva_assets/ukel_livemap_2015_night/rBasic2010.json",
    results2015:        "http://cdn.static-economist.com/sites/default/files/external/minerva_assets/ukel_livemap_2015_night/finalBasic2015.json",
    // ALL SINGLE CONSTITUENCY RESULTS -- 2010 AND 2015
    singleconstitfolder: "http://cdn.static-economist.com/sites/default/files/external/minerva_assets/ukel_livemap_2015_night/consFinalResults/",
    // NOTE: temporarily, for 2017:
    results2017: "files-from-cdn/seatsAndWinners2017.json",
    constitfolder2017: "files-from-cdn/live-results/",
    // These should eventually be replaced by a 'winners' file on CDN. And 2017 single constit files should go in the singleconstitfolder...
    // BREXIT data are local...
    resultsBrexit: "files-from-cdn/brexit.json"
  };

  // STRINGS
  // Just overall strings. Topic-specific strings defined elsewhere
  my.strings = {
    // Date format is "day, full month name, yyyy"
    dateformat: "%d %B %Y",
    // NOTE: does this change? Is it even visible...?
    projecttitle: "<h1 class='title-main'>Election maps</h1><h2 class='title-fly'></h2><div class='update-box'><span class='update-label'>Last updated</span><span class='update-time'>March 10 2014 10.51AM</span></div><div class='title-rubric'>As Britain approaches its most unpredictable election in decades, the current political map reveals a fragmented country. Can one party break out of its strongholds and win a majority or (more likely, it seems) does another 'hung parliament' beckon?</div>",
    keyPrefix: "key_",
    shortMonths: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
    defaultHeader:"",
    defaultSubHeader:"",
    defaultText: "Britain is divided into 650 constituencies. Each sends one MP to the House of Commons in Westminster. Rural seats are much larger than urban ones, so our map shows both the true geographic picture of the country and a schematic view of the political landscape.",
    brexitText: "The United Kingdom European Union membership referendum took place on 23 June 2016"
  };

  // STARTCHECKS
  // Allows for 2 scenarios: bigger and smaller than the threshold set above (windowThreshold.threshold)
  //    name is component name
  //    ready is flag set to true as each component is initialised
  //    if kickoff===true, component's 'update' method is called at startup
  //    if update===true, components are updated after a user-gesture
  // *** IMPORTANT: framework and datafilter MUST be called first *** *** ***
  // INITIALLY, NO SMALL OPTION & THRESHOLD SET SMALL TO PREVENT IT BEING TRIPPED
  my.startchecks = {
    big: {
      // framework: {name: 'framework', ready:false, kickoff:true, update:true},
      // datafilter has no kickoff or update: it does what it has to on init
      datafilter: {name: 'datafilter', ready:false, kickoff:false, update:true},
      dropdowns: {name: 'dropdowns', ready:false, kickoff:true, update:true},
      keys: {name: 'keys', ready:false, kickoff:true, update:true},
      map: {name: 'map', ready:false, kickoff:true, update:true},
      treemap: {name: 'treemap', ready:false, kickoff:true, update:true},
      // footer: {name: 'footer', ready:false, kickoff:true, update:false}
    },
    small: {
      // framework: {name: 'framework', ready:false, kickoff:true, update:true},
      // datafilter has no kickoff or update: it does what it has to on init
      datafilter: {name: 'datafilter', ready:false, kickoff:false, update:true},
      dropdowns: {name: 'dropdowns', ready:false, kickoff:true, update:true},
      keys: {name: 'keys', ready:false, kickoff:true, update:true},
      map: {name: 'map', ready:false, kickoff:true, update:true},
      treemap: {name: 'treemap', ready:false, kickoff:true, update:true},
      // footer: {name: 'footer', ready:false, kickoff:true, update:false}
    }
  };

  // TABS
  my.unlivetabs = {
    0: {
      label: "2015",
      children: {},
      id: "fif"
    },
    1: {
      label: "2010",
      children: {},
      id: "ten"
    },
    2: {
      label: "Brexit",
      children: {},
      id: "brx"
    }
  };
  my.livetabs = {
    0: {
      label: "2017",
      children: {},
      id: "sev"
    },
    1: {
      label: "2015",
      children: {},
      id: "fif"
    },
    2: {
      label: "2010",
      children: {},
      id: "ten"
    },
    3: {
      label: "Brexit",
      children: {},
      id: "brx"
    }
  };

  // RESULTS
  my.results2010 = {
    con: 302,
    lab: 256,
    lib: 56,
    dup:8,
    snp:6,
    snf:5,
    plc:3,
    sdl:3,
    ukp:2,
    grn:1,
    res:1,
    bnp:0,
    ind:5,
    oth:2,
    uup:0,
    total: 650
  };
  my.results2015 = {
    con:331,
    lab:232,
    lib:8,
    grn:1,
    ukp:1,
    bnp:0,
    snp:56,
    plc:3,
    ind:0,
    res:0,
    snf:4,
    sdl:3,
    dup:8,
    uup:2,
    oth:1,
    total: 650
};
// Overall national 'Remain' vote in the referendum:
my.resultsBrexit = {
  val: 48.1,
};

  // PARTIES
  // All lookups for parties: colours, strings...
  // NOTE: revised colours to come
  my.parties = {
    con: {
      id:"con",
      longname:"Conservative Party",
      midname:"Conservative",
      shortname:"Con",
      keyname:"Con",
      colour: "rgba(0, 107, 161, 1)",
      // heatcolour are used for one-party heatmaps
      heatcolour: "#3356f9",
      currentseats: 307
    },
    lab: {
      id:"lab",
      longname:"Labour Party",
      midname:"Labour",
      shortname:"Lab",
      keyname:"Lab",
      colour:"rgba(219, 68, 75, 1)",
      heatcolour: "#df181c",
      currentseats: 258
    },
    lib: {
      id:"lib",
      longname:"Liberal Democrat Party",
      midname:"Lib Dem",
      shortname:"LD",
      keyname:"Lib Dem",
      colour:"rgba(234, 179, 51, 1)",
      heatcolour: "#fd9d28",
      currentseats: 57
    },
    grn: {
      id:"grn",
      longname:"Green Party",
      midname:"Green",
      shortname:"Green",
      keyname:"Green",
      colour:"rgba(54, 153, 139, 1)",
      heatcolour: "#6a9e3f",
      currentseats: 1
    },
    ukp: {
      id:"ukp",
      longname:"UK Independence Party",
      midname:"UKIP",
      shortname:"UKIP",
      keyname:"UKIP",
      colour:"rgba(154, 96, 128, 1)",
      heatcolour: "#79279f",
      currentseats:0
    },
    plc: {
      id:"plc",
      longname:"Plaid Cymru",
      midname:"Plaid Cymru",
      shortname:"PC",
      keyname:"PC",
      colour:"#5eb130",
      heatcolour: "#5eb130",
      currentseats:3
    },
    res: {
      id:"res",
      longname:"Respect",
      midname:"Respect",
      shortname:"Respect",
      keyname:"Respect",
      colour:"#aca580",
      heatcolour: "#aca580",
      currentseats:1
    },
    snp: {
      id:"snp",
      longname:"Scottish National Party",
      midname:"SNP",
      shortname:"SNP",
      keyname:"SNP",
      colour:"#fbca2c",
      heatcolour: "#fbca2c",
      currentseats:6
    },
    bnp: {
      id:"bnp",
      longname:"British National Party",
      midname:"BNP",
      shortname:"BNP",
      keyname:"BNP",
      colour:"#8fbcee",
      heatcolour: "#af781e",
      currentseats:0
    },
    ind: {
      id:"ind",
      longname:"Independent",
      midname:"Ind",
      shortname:"Ind",
      keyname:"Ind",
      colour:"#888888",
      heatcolour: "#888888",
      currentseats:1
    },
    oth: {
      id:"oth",
      longname:"Other",
      midname:"Other",
      shortname:"Other",
      keyname:"Other",
      colour:"#f0dcac",
      heatcolour: "#929ca1",
      currentseats:0
    },
    sdl: {
      id:"sdl",
      longname:"Social Democratic and Labour Party",
      midname:"SDLP",
      shortname:"SDLP",
      keyname:"SDLP",
      colour:"#005223",
      heatcolour: "#005223",
      currentseats:3
    },
    snf: {
      id:"snf",
      longname:"Sinn Fein",
      midname:"SF",
      shortname:"SF",
      keyname:"SF",
      colour:"#8fdb64",
      heatcolour: "#4e6718",
      currentseats:5
    },
    uup: {
      id:"uup",
      longname:"Ulster Unionist Party",
      midname:"Unionist",
      shortname:"UUP",
      keyname:"UUP",
      colour:"#ff6600",
      heatcolour: "#ff6600",
      currentseats:0
    },
    dup: {
      id:"dup",
      longname:"Democratic Unionist Party",
      midname:"DUP",
      shortname:"DUP",
      keyname:"DUP",
      colour:"#800a06",
      heatcolour: "#800a06",
      currentseats:8
    }
  };
  // PARTIES ends

  // CONSOLIDATION LIST is an array of parties that get folded into "other" for small widget
  my.consolidationList = ['dup','uup','bnp','res','ind','plc','snf','snp','sdl'];

  return my;
}());
// CONTROLLER ends

function Widget(){
  // Insert here additional methods shared beetwen the widget
  // e.g. entering animation or preloader
  this.addPreloader = function (){
    if($('.mnv-preloader-overlay', this.el).length===0){
      $("<div class='mnv-preloader-overlay'></div>").appendTo(this.el);
    }
    if($('.mnv-preloader-loader', this.el).length===0){
      $("<div class='mnv-preloader-loader'></div>").appendTo(this.el);
    }
  }

  this.removePreloader = function (){
    $(".mnv-preloader-loader", this.el).fadeOut(200, function(){
      $(this).remove();
      $(".mnv-preloader-overlay", this.el).fadeOut(300, function(){
        $(this).remove();
      });
    });    
  }

  this.bindEvent = function(){
    var me = this;
    this.el.on("loading", function(){
      me.addPreloader();
    });

    this.el.on("loaded", function(){
      me.removePreloader();
    });
  }

}

Widget.prototype.log = function(txt){
  // widgetConfig.minerva.debugMode to be added
  if(window.console && window.console.log){
    console.log(this.id + ' --> ' + txt);
  }
}
function MNVBasic(){
  // Set log Off
  var me = this;
  this.logEnabled = false;
  this.log = function (txt, error){
    // Disabled log but print errors anyway
    if(this.hasOwnProperty('logEnabled') && !this.logEnabled && typeof error === 'undefined'){
      return;
    }
    var msg = '';
    msg = (this.id !== undefined) ? this.id : 'Unspecified widget';
    msg += ' --> ' + txt;
    if(window.console && window.console.log){
      if(error && window.console.error){
        console.error( msg );
      } else {
        console.log( msg );
      }
    }
  };

  this.ready = function(fn) {
    if (document.readyState != 'loading'){
      fn();
    } else {
      document.addEventListener('DOMContentLoaded', fn);
    }
  };

  this.trigger = function(ev, data){
    var myEvent;
    function noCustomEvent(ev, data){
      var myEvent = document.createEvent('CustomEvent');
      myEvent.initCustomEvent(ev, true, true, data);
      return myEvent;
    }
    if (window.CustomEvent) {
      try {
        myEvent = new CustomEvent(ev, {
          detail: data
        });
      }
      catch (e){
        myEvent = noCustomEvent(ev, data);
      }
    } else {
      myEvent = noCustomEvent(ev, data);
    }
    log('triggered: ' + ev + ' with data');
    this.dispatchEvent(myEvent);
  };

  this.ajax = function(url, fn){
    var request = new XMLHttpRequest();
    request.open('GET', url, true);

    request.onload = function() {
      if (request.status >= 200 && request.status < 400) {
        // Success!
        var data = JSON.parse(request.responseText);
        fn(data);
      } else {
        // We reached our target server, but it returned an error
        log('Server error');
      }
    };

    request.onerror = function() {
      // There was a connection error of some sort
      log(this.error);
    };

    request.send();
  }

  this.jsonp = function(url, callbackName, callback) {
    var script = document.createElement('script');
    script.src = url;
    document.body.appendChild(script);

    window[callbackName] = function(data) {
      delete window[callbackName];
      // Get all the node List
      var scripts = document.getElementsByTagName('script');
      if(me.hasAttributeEqualTo(scripts, 'src', script.src )){
        document.body.removeChild(script);
      }
      callback(data);
    };
  }

  this.addClass = function(el, className){
    if (el.classList){
      el.classList.add(className);
    } else {
      el.className += ' ' + className;
    }
  }

  this.removeClass = function(el, className){
    if (el.classList){
      el.classList.remove(className);
    } else {
      el.className = el.className.replace(new RegExp('(^|\\b)' + className.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
    }
  }

  this.hasAttributeEqualTo = function(els, attr, val){
    if(els.tagName){
      return els.hasAttribute(attr) === val;
    } else {
      // els is a nodeList
      var i = 0;
      for(i=0; i< els.length; i++){
        if(els[i].hasAttribute(attr) && els[i][attr] === val){
          return els[i];
        }
      };
      return false;
    }
  }

  this.ordinal_suffix_of = function(i) {
    var j = i % 10,
        k = i % 100;
    if (j == 1 && k != 11) {
        return i + "st";
    }
    if (j == 2 && k != 12) {
        return i + "nd";
    }
    if (j == 3 && k != 13) {
        return i + "rd";
    }
    return i + "th";
  }
}
/*
  Author: Umberto Babini.
  Purpose: This class provide the creation of a singleton object that manage data retrieving for multiple instances of DOM elements
*/
// Init the singleton
/* Public interface to subscribe to the data retrivement
*  @param {object}
*  {
*   'elements': {Array of DOM elements} ID of the object that is subscribing [Mandatory],
*   'url': {String} URL for data retrieval [Mandatory],
*   // If folder and file are used url became optional
*   'folder': {String} To be used with Drupal data retrievemnt,
*   'file':  {String} To be used with Drupal data retrievemnt,
*   'pollingTime': null {Number} ms value for polling this URL,
*   'callbackName': {string} Callback name function that is used on the on the jsonp file
*  }
*/
var MnvDRS = (function () {
  // Instance stores a reference to the Singleton
  var _mnvdrs, mandatoryFieldsList, subscribersList = {}, tmpScript, pollingTimeMin = 10000, hidden, visibilityChange, preSubscribersList = [];
  // Set property for Page visibility API
  if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
    hidden = "hidden";
    visibilityChange = "visibilitychange";
  } else if (typeof document.mozHidden !== "undefined") {
    hidden = "mozHidden";
    visibilityChange = "mozvisibilitychange";
  } else if (typeof document.msHidden !== "undefined") {
    hidden = "msHidden";
    visibilityChange = "msvisibilitychange";
  } else if (typeof document.webkitHidden !== "undefined") {
    hidden = "webkitHidden";
    visibilityChange = "webkitvisibilitychange";
  }

  function init() {
    var subscribe, pollingList = {};

    subscribe = function(subscriberConfig){
      var mandatoryFields;
      if(typeof subscriberConfig !== 'object' ){
        this.log('Configuration object is required');
      }
      mandatoryFields = checkMandatoryFields(subscriberConfig);
      // Check mandatory fields
      if(mandatoryFields===true){
        if(!subscriberConfig.hasOwnProperty('url')){
          if(!subscriberConfig.hasOwnProperty('folder') || !subscriberConfig.hasOwnProperty('file')){
            this.log('You have to specify a folder path on Minerva and a file name on Minerva')
          } else {
            useProxyService(subscriberConfig);
          }
        } else {
          addPreSubscribersList(subscriberConfig);
        }
      } else {
        // Log error message
        this.log(mandatoryFields);
      }
    };

    function addPreSubscribersList(sub){
      preSubscribersList.push(sub);
    };

    function useProxyService(sub){
      var url;
      //  Do something here with the external service to retrieve the folder when available
      url = (!sub.hasOwnProperty(url)) ? 'http://local.demo.economist.com/testdata/' : sub.url;
      //url = (!sub.hasOwnProperty(url)) ? 'http://cdn.static-economist.com/sites/default/files/external/minerva_assets/ukel_map/test/' : sub.url;
      // Manipulate the URL with the incoming data
      sub.url = url + sub.folder + sub.file;
      addPreSubscribersList(sub);
    }

    // Add subscriber element to the list
    function addSubscribers(subscriberConfig){
      // Subscribers list use url like properties
      var sub = subscriberConfig, elements, url = subscriberConfig.url, pollingTime;
      // Already existing url
      if(subscribersList.hasOwnProperty(url)){
        elements = subscribersList[url].elements.concat(subscriberConfig.elements);
        // Use the shortest value asked for
        pollingTime = (Math.round(subscriberConfig.pollingTime) === subscriberConfig.pollingTime) ? Math.min(subscriberConfig.pollingTime, subscribersList[url].pollingTime) : null;
      } else {
        // New subscription
        elements = subscriberConfig.elements
        pollingTime = (Math.round(subscriberConfig.pollingTime) === subscriberConfig.pollingTime) ? subscriberConfig.pollingTime : null;
      }
      if(pollingTime != null && pollingTime<pollingTimeMin){
        log('Polling time is too short, min value is ' + pollingTimeMin);
        return false;
      }
      subscribersList[url] = {
        "elements": elements,
        "pollingTime": pollingTime,
        "callbackName": subscriberConfig.callbackName,
        "url": url,
        "firstRequestQueryString": (subscriberConfig.firstRequestQueryString !== 'undefined') ? subscriberConfig.firstRequestQueryString : false,
        "pollingQueryString": (subscriberConfig.pollingQueryString !== 'undefined') ? subscriberConfig.pollingQueryString : null,
        "pollingURL": (subscriberConfig.pollingURL !== 'undefined') ? subscriberConfig.pollingURL : null,
        "fileFormat":  subscriberConfig.fileFormat
      };

      // Overwrite the callback
      subscribersList[url].callback = function(data){
        for (var i = subscribersList[url].elements.length - 1; i >= 0; i--) {
          // Be sure that the element is present on the page
          if(document.hasOwnProperty('contains')){
            // Out of IE
            if(document.contains(subscribersList[url].elements[i])){
              // Trigger dataProvide event on tags
              _mnvdrs.trigger.call(subscribersList[url].elements[i], 'dataProvide', data);
            } else {
              _mnvdrs.log('Element ' + subscribersList[url].elements[i].id + ' doesn\'t exist');
            }
          } else {
            // You are on IE
            _mnvdrs.trigger.call(subscribersList[url].elements[i], 'dataProvide', data);
          }
        };
      }
      log('Registered new elements for url ' + url);
    }
    // Start requests for each url
    function start(){
      log('Start request')
      // Add all the subscribers on the list
      // Prepare the elements
      for (var i = preSubscribersList.length - 1; i >= 0; i--) {
        preSubscribersList[i].elements = [document.querySelector(preSubscribersList[i].elements)];
        addSubscribers(preSubscribersList[i]);
      };
      // Run request for each url
      for (var url in subscribersList) {
        requestData(subscribersList[url], subscribersList[url].firstRequestQueryString);
        startPolling(subscribersList[url]);
      };
    }

    function requestData(subscriber, useQueryString, usePollingURL){
      log('Requesting data for ' + subscriber.url);
      var url = subscriber.url;

      if(usePollingURL===true){
        url =  subscriber.pollingURL;
      }
      if(useQueryString===true){
        url +=  '?cache=' + subscriber.pollingQueryString();
      }
      if(subscriber.fileFormat==='json'){
        ajax(url, subscriber.callback);
      } else {
        jsonp(url, subscriber.callbackName, subscriber.callback);
      }
    }

    function stopPolling(subscriber){
      window.clearInterval(pollingList[subscriber.url]);
      delete pollingList[subscriber.url];
    }

    function startPolling(subscriber){
      if(subscriber.pollingTime === null){
        return false;
      }
      var useQueryString = (subscriber.hasOwnProperty('pollingQueryString') && typeof subscriber.pollingQueryString === 'function'), usePollingURL = (subscriber.hasOwnProperty('pollingURL') && typeof subscriber.pollingURL === 'string');
      log('Start polling for ' + subscriber.url + ' every ' + subscriber.pollingTime + ' ms. Querystring = ' + useQueryString);
      pollingList[subscriber.url] = setInterval(function(){
        log('Polling for ' + subscriber.url );
        requestData(subscriber, useQueryString, usePollingURL);
      },
      subscriber.pollingTime);
    }
    // If the page is hidden, stop polling
    function pageVisibilityChange() {
      var sub;
      for (var url in subscribersList) {
        sub = subscribersList[url];
        // Stop on hiding
        if (document[hidden]) {
          log('Stopping polling ' +  sub.url);
          stopPolling(sub);
        } else {
          log('Restarting polling ' +  sub.url);
          requestData(sub, sub.firstRequestQueryString);
          startPolling(sub);
        }
      }
    };

    // Check if every  mandatory config propeties is in the expected type
    function checkMandatoryFields(subscriberConfig){
      if(subscriberConfig.elements.tagName){
        // Wrapping single DOM element on an array
        subscriberConfig.elements = [subscriberConfig.elements];
      }
      // Convert HTMLCollection to an array
      if(subscriberConfig.elements.constructor.name==='HTMLCollection'){
        subscriberConfig.elements = [].slice.call(subscriberConfig.elements);
      }
      return true;
    }

    // Inehrit function from Basic
    // TODO Change this part with prototype
    var basic = new MNVBasic();
    this.log = basic.log;
    // Disable logs.
    this.logEnabled = false;
    this.ready = basic.ready;
    this.jsonp = basic.jsonp;
    this.ajax = basic.ajax;
    this.trigger = basic.trigger;
    this.id = 'MnvDRS';
    // Add page visibility change listener
    // Handle page visibility change
    if (typeof document.addEventListener !== "undefined" && typeof document[hidden] !== "undefined") {
      document.addEventListener(visibilityChange, pageVisibilityChange, false);
    }
    // Public methods
    return {
      subscribe: subscribe,
      start: start,
      id: id,
      log: log,
      logEnabled: logEnabled,
      ready: ready,
      trigger: trigger,
      stopPolling: stopPolling
    };
  };

  return {
    // Get the Singleton _mnvdrs if one exists
    // or create one if it doesn't
    getInstance: function () {
      if ( !_mnvdrs ) {
        _mnvdrs = init();
        _mnvdrs.log('New instance of MnvDRS required');
      } else {
        _mnvdrs.log('New instance of MnvDRS required, but one still exist, no init triggered');
      }
      return _mnvdrs;
    }
  };

})();

if(typeof MnvDRSI === 'undefined'){
  var MnvDRSI = MnvDRS.getInstance();
  // Document ready
  $(document).ready(function(){
    MnvDRSI.start();
  });
}
/*
  Author: Umberto Babini.
  Purpose: This class provide utilities for the creation of queryString primarly used to bypass server cache on demand
*/
function MNVqueryStringGenerator(){
  // Create a queryString base on the day date and the
  function UTCMinuteSteps(stepMinuteInterval){
    var d = new Date();
    return d.getUTCFullYear() + '-' + d.getUTCMonth() + '-' + d.getUTCDate() + '-' + d.getUTCHours() + '-' + (d.getUTCMinutes() - ( d.getUTCMinutes() % stepMinuteInterval));
  }
  return {
    UTCMinuteSteps: UTCMinuteSteps
  }
}
/*
  Author: Umberto Babini.
  Purpose: Provide a simple update time on 'last-update' field
*/
function MNVLastUpdate(container, selector, fadeOutTiming, timestamp){
  var update, tag, elSelector, fadeOutTiming, me, defaultTimestamp;
  // Set default value
  elSelector = (typeof selector === 'undefined') ? '.last-update' : selector;
  fadeOutTiming = (typeof selector === 'undefined') ? 2000 : fadeOutTiming;
  me = this;
  tag = container.querySelector(elSelector);

  update = function(){
    var timestampString = (typeof timestamp === 'function') ? timestamp() : timestamp;
    if(tag.length===0){
      me.log('Unable to find the element ' + elSelector);
    } else {
      me.addClass(tag, 'highlight');
      (document.all) ? (tag.innerText = timestampString) : (tag.textContent = timestampString);
      // Remove higlight after fadeOutTiming
      setTimeout(function(){
        me.removeClass(container.querySelector(elSelector), 'highlight');
      }, fadeOutTiming);
    }
  };

  // defaultTimestamp = function(){
  //   var d = new Date();
  //   var weekday = new Array(7);
  //   weekday[0]=  "Sunday";
  //   weekday[1] = "Monday";
  //   weekday[2] = "Tuesday";
  //   weekday[3] = "Wednesday";
  //   weekday[4] = "Thursday";
  //   weekday[5] = "Friday";
  //   weekday[6] = "Saturday";

  //   var shortMonthsName = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  //   var n = weekday[d.getDay()];
  //   return n + ' ' + d.getDate() + ' ' + shortMonthsName[d.getMonth()] + ' ' + d.getFullYear() + ' at ' + ISO(d.getHours()) + ':' + ISO(d.getMinutes()) ;
  // }

  defaultTimestamp = function(){
    var d = new Date();
    var shortMonthsName = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return d.getHours() + ':' + ISO(d.getMinutes()) + ' ' + me.ordinal_suffix_of(d.getDate()) + ' ' + shortMonthsName[d.getMonth()] + ' ' + d.getFullYear() ;
  }

  function ISO(nr){
    var str = nr.toString();
    if(str.length<2){
      str = '0' + str;
    }
    return str
  }
  me.addClass(tag, 'not-highlight');
  timestamp = (typeof timestamp === 'undefined') ? defaultTimestamp : timestamp;
  update();

  return {
    update: update
  }
}

MNVLastUpdate.prototype = new MNVBasic();
"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

// JSONP CALLBACKS FOR:
// Brexit results
  function resultsBrexitCB() {
    var key, makeObj, makeArray;
    key = "resultsBrexit";
    makeObj = true;
    makeArray = false;
    mnv_ukelmap.datafilter.filterResults(null, arguments[0], key, makeObj, makeArray);
  }
// 2010 results
  function results2010BasicCB() {
    var key, makeObj, makeArray;
    key = "results2010";
    makeObj = true;
    makeArray = false;
    mnv_ukelmap.datafilter.filterResults(null, arguments[0], key, makeObj, makeArray);
  }
// 2015 results
  function results2015BasicCB() {
    var key, makeObj, makeArray;
    key = "results2015";
    makeObj = true;
    makeArray = false;
    mnv_ukelmap.datafilter.filterResults(null, arguments[0], key, makeObj, makeArray);
  }
// 2017 results
  function seatsAndWinners2017CB() {
    var key, makeObj, makeArray;
    key = "results2017";
    makeObj = true;
    makeArray = false;
    mnv_ukelmap.datafilter.filterResults(null, arguments[0], key, makeObj, makeArray);
  }
// Constituency lookup
  function constituencyLookupCB() {
    var key, makeObj, makeArray;
    var key = "constituencyLookup";
    makeObj = true;
    makeArray = true;
    mnv_ukelmap.datafilter.filterResults(null, arguments[0], key, makeObj, makeArray);
  }
// Literal paths
  function ukLiteralPathsCB() {
    var key, makeObj, makeArray;
    var key = "literalPaths";
    makeObj = true;
    makeArray = false;
    mnv_ukelmap.datafilter.filterResults(null, arguments[0], key, makeObj, makeArray);
  }
// Single constituency data
  function resultCB() {
    var key, makeObj, makeArray;
    mnv_ukelmap.datafilter.filterOneConstit(null, arguments[0], key);
  }


// FILTER DATA
mnv_ukelmap.datafilter = (function(){
  var my, model, modelflags, controller, callbackFlags, filterDone, makeCurrentData,
    allDataReady, allReadyFlags, jsonp2010, filterJSON, storeInModel, filterConstitLookupData,
    goJson, preloader, loadLiteralData;
  my = {};
  model = mnv_ukelmap.model;
  modelflags = model.flags;
  controller = mnv_ukelmap.controller;
  preloader = new Widget();

  // LOCAL FLAGS
  my.localflags = {
    dataindex: "dataindex",
    requestedconstit: "requestedconstit"
  }

  // FILTER DONE
  // Callback tells controller that all data has been processed
  filterDone = function() {
    var controller = mnv_ukelmap.controller;
    controller.startchecks('datafilter');
    preloader.removePreloader();
  };
  // FILTER DONE ends

  // SINGLE CONSTITUENCY FILES: LOAD ONE CONSTIT DATA
  my.fetchOneConstitData = function(filename, correction) {
    // Key for callback lookup
    var cb = "resultCB";
    // clearCache is false, since goJson will check 'correction'
    // and apply it if not undefined
    var clearCache = false;
    goJson(filename, cb, clearCache, correction);
  }


  // LITERAL MAP PATHS
  my.loadLiteralData = function() {
    var filename = model.sourcefiles.literalpaths;
    // Key for callback lookup
    var cb = "ukLiteralPathsCB";
    var clearCache = false;
    goJson(filename, cb, clearCache);
  }

  // ALL READY FLAGS contains a series of flags, all of which
  // must be inferentially set TRUE before we can tell the
  // controller we're ready to proceed...
  allReadyFlags = {
    results2010: false,
    results2015: false,
    results2017: false,
    constituencyLookup: false
  };
  // ALL READY FLAGS ends

  // ALL DATA READY
  // Loops through allReadyFlags object;
  // returns false if ANY flag is (still) false
  allDataReady = function() {
    for (var cb in allReadyFlags) {
      if (!allReadyFlags[cb]) {
        return false;
      }
    }
    return true;
  };
  // ALL DATA READY ends

  // FILTER ONE CONSTIT
  my.filterOneConstit = function(error,json) {
    var dataObj, id, dataindex, objName;
    // I don't think we ever actually get an error...
    if (error) {
      dataObj = undefined;
    }
    else {
      dataObj = json;
      id = dataObj.id;
    }

    if (typeof dataObj === "object") {
      if (id !== undefined) {
        dataindex = model.flags.dataindex;
        if (dataindex === "sev") {
          objName = "singleResults2017";
          // Fish any correction value out of the global data node
          dataObj.corr = model.data.results2017Obj[id].corr;
        } else if (dataindex === "fif") {
          objName = "singleResults2015";
        }  else if (dataindex === "ten") {
          objName = "singleResults2010";
        } else {
          // Brexit
          objName = "singleResults2015";
        }
        // Update relevant single constituency repository in model.data
        model.data[objName][id] = dataObj;
        // And notify controller that we've loaded the constit data file:
        mnv_ukelmap.controller.findConstitListener(id, true);
      }
    }
  };
  // FILTER ONE CONSTIT ends

  // FILTER RESULTS
  // Filters a json file
  // 'key' determines name of property of model.data that is created
  my.filterResults = function(error,json,key,makeObj,makeArray) {
    var dataObj, dataArray, i, o, id, dataArrayName, dataObjName, isSmall;
    // Error aborts. In theory, this should mean that if no data file
    // is found, nothing at all happens...
    if (error) {
      return;
    }
    // Big or small?
    isSmall = mnv_ukelmap.controller.isSmallVersion();

    // Global results file use the winnersbyconstit node:
    if ( (key === "results2017") || (key === "results2015") || (key === "results2010") ) {
      json = json.winnersbyconstit;
    }

    // I may want to filter data into:
    //    1) an object with named nodes,
    //    2) an array...
    // The incoming json is an array of objects, which is, I think,
    // pretty much what I want!

    dataObj = {};
    dataArray = [];
    for (i = 0; i < json.length; i ++) {
      o = json[i];
      id = o.id;
      // Exclude blanks
      if (id.length > 0) {
        dataObj[o.id] = o;
        dataArray.push(o);
      }
    }
    // Store 2 versions of the data: as array and named objects
    // *** No sorting done... ***
    if (makeArray) {
      dataArrayName = key + "Array";
      model.data[dataArrayName] = dataArray;
    }
    if (makeObj) {
      dataObjName = key + "Obj";
      model.data[dataObjName] = dataObj;
    }

    // *** Literal paths ***
    // Inferentially return before the callback, to prevent
    // the literal paths being read in over and over again!
    if (key === "literalPaths") {
      // Literal paths are in, so we can drill another nasty hole thro
      // the structure, back to the map's toggleListener...
      mnv_ukelmap.map.toggleListener();
      return;
    }
    // Still here? This is one of the 'default' files...
    // Trip datafile-specific flag:
    allReadyFlags[key] = true;
    // Now check all flags to see if we're ready to finish...
    if (allDataReady()) {
      // This comm'd out function overlaid by-elections on 2010 data
      //makeCurrentData();
      // Tell controller that all data has been filtered
      filterDone();
    }
  };
  // FILTER RESULTS ends

  makeCurrentData = function() {
    var d2010Obj, currentObj, thisCurrentResult, id, this2010Result, currentArray;
    d2010Obj = model.data.results2010Obj;
    currentObj = model.data.byelectionsObj;
    currentArray = [];
    for (id in d2010Obj) {
      if (d2010Obj.hasOwnProperty(id)) {
        this2010Result = d2010Obj[id];
        thisCurrentResult = currentObj[id];
        if (thisCurrentResult === undefined) {
          // No 'current result' (ie, no byelection); so append seat record
          currentObj[id] = this2010Result;
        }
        else {
          // There was a by-election. Use that result, but append demographics
          currentObj[id].pop = this2010Result.pop;
          currentObj[id].hpr = this2010Result.hpr;
          currentObj[id].sal = this2010Result.sal;
        }

        // Either way: append each current result to the 'current data' array
        currentArray.push(currentObj[id]);
      }
    }
    // So, in theory, we have our existing results2010Obj and results2010Array,
    //    neither of which has changed
    // We also have currentObj and current, which I have to save to model.data
    // FOR THIS FIRST VERSION, I'M JUST SETTING THE CURRENT DATA TO 2010-RESULTS !!!
    model.data.results2010Obj = currentObj;
    model.data.results2010Array = currentArray;
  };


  // FILTER JSON
  // Filters a JSON file (in practice the literal map paths)
  filterJSON = function(datafile, key) {
    d3.json(datafile, storeInModel(key, json));
  };
  // FILTER JSON ends

  // Save JSON file in model
  storeInModel = function(key, json) {
    var dataObjName;
    // Save to model.data, unfiltered:
    dataObjName = key + "Obj";
    model.data[dataObjName] = json;
    return;
    // Trip datafile-specific flag:
    allReadyFlags[key] = true;
    // Now check all flags to see if we're ready to finish...
    if (allDataReady()) {
      // Callback 'filterDone' tells controller that all data has been filtered
      filterDone();
    }
  }

  my.getCacheString = function() {
    var istest, checkPts, now, str, hour, i, pt, result;
    // Test or live:
    // FOR NOW, AT LEAST, FORCE 'TEST' WITH RANDOM NUMBER...
    //istest = (model.sourcefiles.mid === "test");
    istest = true;
    if (istest) {
      return "&d=" + parseInt(Math.random()*100000);
    }
    // Still here? Use time:
    // Current time
    now = new Date(Date.now());
    // Init returned string:
    str = "&d=" + strings.shortMonths[now.getUTCMonth()] + "-";
    str += now.getUTCDate() + "-";
    // Array of times to check
    checkPts = model.checkpoints;
    // Now as "hh"
    hour = now.getUTCHours();
    result = 0; // by default
    // Loop through checkpoints and get latest
    for (i = 0; i < checkPts.length; i ++) {
      pt = checkPts[i];
      if (hour < pt) {
        break;
      }
      else {
        result = pt;
      }
    }
    return str + result;
  }


  // GO JSON
  goJson = function(filename, padding, addCacheString, correction) {
    var  jsonpStr, cacheStr, corr;
    cacheStr = "";
    if (correction !== undefined) {
      // Individual 2017 results may be 'corrections' (flagged in the global/basic result)
      // So for one-constit-result files, addCacheString is false and we look for a
      // correction value for the cache query...
      cacheStr = "&c=" + correction;
    }
    else if (addCacheString) {
      cacheStr = my.getCacheString();
    }
    jsonpStr = filename + '?callback=d3.jsonp.' + padding + cacheStr;
    // console.log(jsonpStr);
    d3.jsonp(jsonpStr, function() {});
  };
  // GO JSON ends


  // INIT
  // Calls functions to read in the various data files
  my.init = function() {
    var filename, clearCache, cb, key, widget;
    preloader.el = $('.ukelmap-map-div');
    preloader.addPreloader();

    // BREXIT RESULTS
    filename = model.sourcefiles.resultsBrexit;
    // Key for callback lookup is set by the file-specific callback (see top)
    cb = "resultsBrexitCB";
    // During devel, at least, I have to force a cache-clear
    clearCache = true;
    // Dive in after the data:
    goJson(filename, cb, clearCache);

    // 2010 RESULTS
    filename = model.sourcefiles.results2010;
    // Key for callback lookup is set by the file-specific callback (see top)
    cb = "results2010BasicCB";
    // During devel, at least, I have to force a cache-clear
    clearCache = true;
    // Dive in after the data:
    goJson(filename, cb, clearCache);

    // 2015 RESULTS
    filename = model.sourcefiles.results2015;
    // Key for callback lookup is set by the file-specific callback (see top)
    cb = "results2015BasicCB";
    // During devel, at least, I have to force a cache-clear
    clearCache = true;
    // Dive in after the data:
    goJson(filename, cb, clearCache);

    // Binding for callback
    widget = $('.mnv-map-uk-election-2017-election-night');
    widget.bind('dataProvide', function(data){
      // Update last update field
      var lastUpdate = (typeof lastUpdate === 'undefined') ? new MNVLastUpdate(this) : lastUpdate.update(this);
      swallow2017BasicData(data.detail);
      });

    // CONSTITUENCY LOOKUP
    // For constit names and schematic coordinates
    filename = model.sourcefiles.constituencylookupdata;
    cb = "constituencyLookupCB";
    clearCache = false;
    goJson(filename, cb, clearCache);

  };
  // INIT ends

  // SWALLOW 2017 BASIC DATA
  // Called from init, every time the service delivers a new set of 'global'
  // 2017 data
  function swallow2017BasicData(data) {
    var time, seats, winners, defaultTextObj = {};
    time = data.time;
    seats = data.seats;
    winners = data.winnersbyconstit;

    defaultTextObj.head = data.default_head;
    defaultTextObj.sub = data.default_sub;
    defaultTextObj.bod = data.default_text;
    // Put party seat counts and time of update on model
    model.results2017 = seats;
    model.flags.latestupdate = time;
    // And basic constit results (winner, correction)
    model.data.results2017Array = winners;
    var temp = {};
    for (var i in winners) {
      var id  = winners[i].id;
      temp[id] = winners[i];
    }
    model.data.results2017Obj = temp;

    // If this is the first load of the 2017 global results,
    // we want to kick the controller. But we can only do this once.
    // So check that it still needs to be done:
    if (!allDataReady()) {
      // And trip the flag (tells us we're ready to go on first load; redundant thereafter)
      allReadyFlags.results2017 = true;
      // NOW, if we're ready to go... GO!
      if (allDataReady()) { filterDone(); }
    }
    // Previous, if it ran,  has allowed other components to get ready
    // Now worry about the 2017 data.
    // After a short breath, advise the controller...
    setTimeout( function() {
      // Pass defaultTextObj. If !== undefined, controller will update the field...
      mnv_ukelmap.controller.new2017BasicDataListener(defaultTextObj);
    },500);
  }
  // SWALLOW 2017 BASIC DATA ends

  // UPDATE
  // If model has flagged a new requested constituency,
  // let's go looking for it...
  my.update = function() {
    var requestedconstit, dataindex, change;
    requestedconstit = modelflags.requestedconstit;
    dataindex = modelflags.dataindex;
    change = false;
    if (requestedconstit !== my.localflags.requestedconstit) {
      my.localflags.requestedconstit = requestedconstit;
      change = true;
    }
    if (dataindex !== my.localflags.dataindex) {
      my.localflags.dataindex = dataindex;
      change = true;
    }
    if (change) {
      // So requestedconstit is the id of the constit we want...
      findConstitData(requestedconstit);
    }
  };
  // UPDATE ends

  // FIND CONSTITUENCY DATA
  // The job of this function is to ensure that the data is available
  // then update the model's currentconstit flag so that other components
  // can respond
  function findConstitData(id) {
    var dataindex, check, filename, correction, modeldatacorrection;
    // If no constit to find...
    if (id === undefined) { return; }
    dataindex = modelflags.dataindex;
    if (dataindex === "sev") {
      // 2017: check if constit has declared yet,
      // by looking in global file
      if (!hasDeclared(id)) {
        mnv_ukelmap.controller.findConstitListener(id, false);
        return;
      }
    }
    // Still here? Whether it's 2010, 2015 or 2017, or whatever,
    // there "must" be a single-constit result.
    // Do we already have it in model.data?
    if (dataindex === "sev") {
      check = model.data.singleResults2017[id];
      // BUT...
      // ...we also have to check whether any existing 'stored' correction value
      // matches the latest received in the polled global file.
      // Get the constit's corr value from the global data file node:
      correction = model.data.results2017Obj[id].corr;
      // Check against any stored copy
      if (check !== undefined) {
        modeldatacorrection = check.corr;
        if (modeldatacorrection !== correction) {
          // Stored and 'new' correction values don't match
          // So we want to force the load of a new file by
          // pretending there's no stored data:
          check = undefined;
        }
      }
    }
    else if (dataindex === "fif") {
      check = model.data.singleResults2015[id];
    } else if (dataindex === 'ten') {
      check = model.data.singleResults2010[id];
    }
    else if (dataindex === 'brx') {
      // Brexit wants a 2015 constit result
      check = model.data.singleResults2015[id];
    }
    if (check !== undefined) {
        mnv_ukelmap.controller.findConstitListener(id, true);
        return;
    }
    // Still here? We don't have the data.
    // So load it and put it into model.data...
    // Construct a file name. For now, using "r" + year + "_" + id;
    // Temporary path
    filename = model.sourcefiles.singleconstitfolder;
    if (dataindex === "sev") {
      filename += "r2017";
      // NOTE: during local tests, override with local folder:
      // console.log('Inferentially pointing to local single-constituencies folder for 2017 results...')
      filename = model.sourcefiles.constitfolder2017 + 'r2017';
    } else if (dataindex === "fif") {
      filename += "r2015";
    } else if (dataindex === "ten") {
      filename += "r2010";
    } else {
      // Brexit uses 2015
      filename += "r2015";
    }
    filename += id + ".json";
    // Now jump out of the aeroplane to read it...
    // with correction value...
    my.fetchOneConstitData(filename, correction);
  }
  // FIND CONSTITUENCY DATA ends

 // HAS DECLARED
  // For 2017, checks the global object for the constit.
  // Returns true if it has apparently declared...
  function hasDeclared(id) {
    var results,
      hasDec = false;
    results = model.data.results2017Obj;
    if (results !== undefined) {
      if (results[id] !== undefined) {
        hasDec = true;
      }
    }
    return hasDec;
  }
  // HAS DECLARED ends



return my;
}());
// FILTER DATA ends

"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

// CONTROLLER
mnv_ukelmap.controller = (function(){
  var my, model, modelFlags, strings, componentsList, kickoff, updateAllComponents;
    // updateLineChart, updateChartHeaders, updateOnePollBarChart,
    // updateContributionsBarChart, updateBios, upda   teInfobox, updateSource, componentsList,
    // updateAllComponents, modelFlags;
  my = {};
  model = mnv_ukelmap.model;
  modelFlags = model.flags;
  strings = model.strings;


  // KICK-OFF is called once all components have completed their init processes
  // If a component is set to 'kickoff:true' in the startchecks,
  // its update method is called automatically at startup...
  kickoff = function() {
    var flags, mapIndex, dataIndex, c, item, component;
    mapIndex = modelFlags.mapindex;
    dataIndex = modelFlags.dataindex;
    // Which components we auto-update depends upon kickoff flags in list of components
    // Now loop through componentsList. If any is false, return...
    for (c in componentsList) {
      if (componentsList.hasOwnProperty(c)) {
        item = componentsList[c];
        if (item.kickoff) {
          //console.log("Kicking off " + item.name);
          component = mnv_ukelmap[item.name];
          component.update();
        }
      }
    }
    // This setTimeout gives us a breather, then sets up things that
    // otherwise get trampled by other juggling during initial load
    setTimeout(function(){
      // Hack for small devices only forces modile schematic view
      // once everyone's settled in their seats...
      // if (window.innerWidth < model.windowThreshold.threshold) {
      //   mnv_ukelmap.map.toggleListener('mobile');
      // }
      // Ditto for the 'kill' button on the livesearch field
      d3.select('.mnv-ec-livesearch').select("button")
      .on('click', function(){
         mnv_ukelmap.framework.viewConstituency(false);
          // Pass constituency id (or undefined) to controller:
          mnv_ukelmap.controller.liveSearchSelectionListener(undefined);
        });
    }, 500);
  };
  // KICK-OFF ends

  // UPDATE ALL COMPONENTS
  // Called by almost all event catchers. Calls update method
  // of all components listed (big/small)
  updateAllComponents = function() {
    // componentsList is a global
    var c, item, component;
    for (c in componentsList) {
      if (componentsList.hasOwnProperty(c)) {
        item = componentsList[c];
        if (item.update) {
          //console.log("Updating item " + item.name);
          component = mnv_ukelmap[item.name];
          component.update();
        }
      }
    }
  };
  // UPDATE ALL COMPONENTS ends



  // EVENT LISTENERS
  // ---------------
  // DROPDOWN LISTENER
  // Receives dataset index
  my.dropdownListener = function(ddIndex) {
    // Look up id for that tab, and pass to flags
    modelFlags.dataindex = model.tabs[ddIndex].id;
    // And to ensure any active constit is available, set request flag...
    model.flags.requestedconstit = model.flags.currentconstit;
    // ...and set current constit off until we get a data response
    model.flags.currentconstit = undefined;
    // Mark state of the widget
    // Create D3 classed config obj
    // { 'className': true/false }
    var classesConf = {}, i = 0;
    for (var prop in model.tabs) {
      classesConf['tabs-' + model.tabs[i].id] = (i===ddIndex);
      i++;
    }
    mnv_ukelmap.framework.markState(classesConf);
    updateAllComponents();
  };
  // KEY LISTENER
  my.keyListener = function(kID) {
    // console.log("Party id: " + kID);
  };
  // MAP: ocean and paths
  my.oceanRolloverListener = function() {
    // console.log("Ocean rollover heard by controller");
  };
  my.oceanClickListener = function() {
    model.flags.requestedconstit = undefined;
    model.flags.currentconstit = undefined;
    updateAllComponents();
  };
  my.pathClickListener = function(pID) {
    model.flags.requestedconstit = pID;
    updateAllComponents();
  };
  // TREE MAP
  my.treeMapRolloverListener = function(pID) {
    // console.log("Rolled over tree map: " + pID);
  };
  // LIVE SEARCH
  my.liveSearchSelectionListener = function(id) {
    //model.flags.currentconstit = id;
    model.flags.requestedconstit = id;
    model.flags.zoomconstit = id;
    updateAllComponents();
  };
  my.resetButtonListener = function() {
    model.flags.requestedconstit = undefined;
    model.flags.zoomconstit = undefined;
    model.flags.currentconstit = undefined;
    updateAllComponents();
  }
  // Passed back after the datafilter has looked for a single constit
  my.findConstitListener = function(id, available) {
    // console.log("Constit " + id + ": availability -- " + available);
    model.flags.currentconstit = id;
    model.flags.constitavailable = available;
    updateAllComponents();
  }
  // Tripped after datafilter has polled new live data
  my.new2017BasicDataListener = function(strObj) {
    var head, sub, bod;
    head = strObj.head;
    sub = strObj.sub;
    bod = strObj.bod;
    // There's a counter...
    model.flags.updatecounter ++;
    updateAllComponents();
    // And the default text strings can be passed in...
    if (head !== undefined) {
      // Update now and store for future reference...
      d3.select(".default-header")
        .text(head);
      strings.defaultHead = head;
    }
    if (sub !== undefined) {
      // Update now and store for future reference...
      d3.select(".default-subheader")
        .text(sub);
      strings.defaultsub = sub;
    }
    if (bod !== undefined) {
      // Update now and store for future reference...
      d3.select(".default-body")
        .text(bod);
      strings.defaultText = bod;
    }
  }

  // GET WIDGET SIZE
  // Called from initFramework (this component, below)
  // Are we bigger or smaller than the threshold?
  function getWidgetSize() {
    model.windowThreshold.small = my.isSmallVersion();
    if (model.windowThreshold.small) {
      // componentsList is a global, since
      // my.initOtherComponents and my.startchecks also refer to it:
      componentsList = model.startchecks.small;
    }
    else {
      componentsList = model.startchecks.big;
    }
  }
  // GET WIDGET SIZE ends

  // IS SMALL VERSION
  my.isSmallVersion = function() {
    var size, threshold;
    threshold = model.windowThreshold.threshold;
    size = parseInt(d3.select(".mnv-map-uk-election-2017-election-night").style("width"),10);
    return  size <= threshold;
  }
  // IS SMALL VERSION ends

  // INIT FRAMEWORK
  // Called from init.js on document.ready
  // Housekeeping: widget size; "today"...
  // Assembles the list of active components (as defined in model.startchecks),
  // then init function in each...
  my.initFramework = function() {
    var now, today;
    // Define "today" as zero hours today (midday?)
    now = new Date(Date.now());
    today = now.getUTCDate() + " " + strings.shortMonths[now.getUTCMonth()] + " " + now.getUTCFullYear();
    today += " 00:00:00";
    today = Date.parse(today);
    // Slap into the model:
    model.data.today = today;

    // Default tab definition:
    model.tabs = model.unlivetabs;

    // How big are we today?
    getWidgetSize();

    // Force the framework: all foundations must be in place before
    // other components can build on top:
    mnv_ukelmap.framework.init();
  };
  // INIT FRAMEWORK ends


  // INIT OTHER COMPONENTS
  // Called from framework when it has built the foundations
  // for other components
  my.initOtherComponents = function() {
    var n, item, component;
    // Loop through startchecks, running init on each component:
    for (n in componentsList) {
      /*
      // To debug initialisation, set string to component name
      if (n === 'keys') {
        console.log(n);
      }
      */
      if (componentsList.hasOwnProperty(n)) {
        item = componentsList[n];
        component = mnv_ukelmap[item.name];
        if (typeof component === "object") {
          component.init();
        }
      }
    }
  };
  // INIT OTHER COMPONENTS ends

  // START CHECKS is called by the INIT method of each component to verify that
  // all foundations are in place...
  my.startchecks = function(component) {
    var c, check;
    // First, set property matching calling component to true:
    // (passed by to model by reference)
    componentsList[component].ready = true;
    // Now loop through componentsList. If any is false, return...
    for (c in componentsList) {
      if (componentsList.hasOwnProperty(c)) {
        check = componentsList[c].ready;
        if (!check) {
          //console.log("Component " + component + " is ready... but we're not ready overall...");
          return;
        }
      }
    }
    // Still here? All components are ready, so...
    //console.log("All components initialised. Kicking off...")
    kickoff();
  };

  return my;
}());
// CONTROLLER ends

/*
  Module is responsible for general wrapper
*/
"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

// FRAMEWORK constructor
// General framework. Draws the basic structure and populates
// title and other high-level divs with text.
mnv_ukelmap.framework = (function(){
  var my, model, controller, strings, frameworkResize, mnvWidget,
    mainWrapper, buildFramework, markVersion;
  my = {};
  controller = mnv_ukelmap.controller;
  model = mnv_ukelmap.model;
  strings = model.strings;

  // LOCAL FLAGS
  my.localflags = {
    visiblehead: false
  };
  // LOCAL FLAGS ends
  // Mark container with class for a specific version
  markVersion = function(version){
    mnvWidget
      .classed("version-small", false)
      .classed("version-big", false)
      .classed("version-" + version, true);
  };
  // Mark the viev constituency state
  my.viewConstituency = function(show){
    mnvWidget.classed("view-constituency", show);
    if (!show) { controller.resetButtonListener(); }
  };

  // Add and remove classes to the widget to mark a specific state
  // Used for example on tabs click
  my.markState = function(classesOption){
    if(typeof classesOption !== 'object'){
      return false;
    }
    mnvWidget.classed(classesOption);
  };

  my.isZoomed = function(zoom){
    mnvWidget.classed("zoom-on", zoom);
  };

  my.inViewKey = function(show){
    mnvWidget.classed("view-key", show);
  };
  // FRAMEWORK-RESIZE
  // Responds to window resize event watcher defined in init
  // Calls resize functions of the various elements...
  frameworkResize = function() {
    var componentlist, n, component, resize, version;

    if (controller.isSmallVersion()) {
      version = "small";
      // SMALL framework:
      componentlist = model.startchecks.small;
    }
    else {
      version = "big";
      // BIG framework
      componentlist = model.startchecks.big;
    }
    markVersion(version);
    // Loop through all components listed.
    // If component has a "resize" function, kick it--
    for (n in componentlist) {
      if (componentlist.hasOwnProperty(n)) {
        component = mnv_ukelmap[componentlist[n].name];
        if (typeof(component.resize) === "function") {
          component.resize();
        }
      }
    }
  };
  // FRAMEWORK-RESIZE ends


  // *** FRAMEWORK CONSTRUCTOR ***
  // One constructor for big or wmall, called from init, below

  buildFramework = function() {
    var subdivs = [], sliderDiv, footer;
    markVersion((controller.isSmallVersion())? 'small' : 'big');
    // Top-level
    // Title; dropdowns; big central div for key, map and (?) any chart; footer
    if(my.localflags.visiblehead){
      subdivs.push("ukelmap-header-div");
    }
    subdivs.push("ukelmap-topic-div","ukelmap-mainmap-div", "ukelmap-footer-div");
    mainWrapper.selectAll("div")
      .data(subdivs)
        .enter().append("div")
        .attr("class", function(d) { return d; })
    ;

    footer = d3.select(".ukelmap-footer-div");

    footer.append('span')
      .attr('class','last-update-label')
      .text('Results at: ')
    ;

    footer.append('span')
      .attr('class','last-update')
    ;

    if(my.localflags.visiblehead){
      buildHeader();
    }

    // Populate mainmap div
    subdivs = ["ukelmap-tree", "ukelmap-map-div", "ukelmap-keys-div"];
    d3.select(".ukelmap-mainmap-div").selectAll("div")
      .data(subdivs)
        .enter().append("div")
        .attr("class", function(d) { return d; })
    ;

   // Populate tree div. Key is essential. Chart is
   // negotiable / may turn into an infobox or whatever...
    subdivs = ["ukelmap-treetext-top", "ukelmap-treechart", "ukelmap-treetext-bottom"];
    d3.select(".ukelmap-tree").selectAll("div")
      .data(subdivs)
        .enter().append("div")
        .attr("class", function(d) { return d; })
    ;
    // Append zoom bar
    appendMapBar.call(d3.select(".ukelmap-treetext-top"));
    appendConstituencyTemplate.call(d3.select(".ukelmap-treetext-top"));
    // Flag that framework is ready...
    controller.initOtherComponents();

  };
  // Build header
  function buildHeader(){
    // Populate title div: flash and project title
    var subdivs = [
      // {name:"redflash-div",string: ""},
      {name:"ukelmap-titlestring-div",string: strings.projecttitle}
    ];
    d3.select(".ukelmap-header-div").selectAll("div")
      .data(subdivs)
        .enter().append("div")
        .attr("class", function(d) { return d.name; })
        .html(function(d) {return d.string;})
    ;
  }

  // BUILD FRAMEWORK ends
  // Add MapBar
  function appendMapBar(){
    var toggleContainer = this.append("div")
      .attr("class", "toggler-container");

    // Append the container for the default (no constit selected) text
    my.defaultTextContainer = this.append("div")
      .attr("class", "default-text-container")
      //.text(strings.defaultText)
      ;
    my.defaultTextContainer.append("div")
      .attr("class", "default-header")
      .text(strings.defaultHeader);
    my.defaultTextContainer.append("div")
      .attr("class", "default-subheader")
      .text(strings.defaultSubHeader);
    my.defaultTextContainer.append("div")
      .attr("class", "default-body")
      .text(strings.defaultText);

    // Append Back to UK and Key button for small version
    var togglerViews = toggleContainer.append("div")
      .attr("class","toggle-views");

    var togglerButton = togglerViews.append("button")
      .attr("class","toggle-views-btn toggle-views-back-to-uk")
      ;

    togglerButton.on("click", function(){
        model.flags.currentconstit = undefined;
        d3.selectAll(".mappath-hover").remove();
        my.viewConstituency(false);
      });

    togglerButton
      .append("span")
      .attr("class","hide-on-small")
      .text("Reset");

    togglerButton.append("span")
      .attr("class","hide-on-big")
      .text("Back");

    togglerViews.append("button")
      .attr("class","toggle-views-btn toggle-views-key")
      .on("click", function(){
        my.inViewKey(true);
      })
      .text("Key");

    var toggler = toggleContainer.append("div")
      .attr("class","toggler")
      .on("click", mnv_ukelmap.map.toggleListener );

    toggler.append("div")
        .attr("id","map-toggler")
        .attr("class","tgl toggler-btn")
        ;

    var label = toggler.append("div")
        .attr("class","tgl-btn");

    label
      .append("div")
      .attr("class","map-schematic")
      .attr("datatooltip", "Map");

    label
      .append("div")
      .attr("class","map-linear")
      .attr("datatooltip", "Schematic");

  };
  // Add constituency data
  function appendConstituencyTemplate(){

    var constInfo = this.append("div").attr("class","constituency-info");

    // var togglerViews;
    // // Append Back to UK and Key button for small version
    // togglerViews = constInfo.append("div")
    //   .attr("class","toggle-views");

    // togglerViews.append("button")
    //   .attr("class","toggle-views-btn toggle-views-back-to-uk")
    //   .on("click", function(){
    //     my.viewConstituency(false);
    //   })
    //   .text("Back to UK");

    // togglerViews.append("button")
    //   .attr("class","toggle-views-btn toggle-views-key")
    //   .on("click", function(){
    //     my.inViewKey(true);
    //   })
    //   .text("Key");

    constInfo.append("div")
        .attr("class","region");

    constInfo.append("div")
        .attr("class","constituency");


    var party = constInfo.append("div")
        .attr("class","party");
    party.append("span").attr("class","party-name");
    party.append("span").attr("class","party-status");

    var mp = constInfo.append("div")
        .attr("class","mp");
    mp.append("span").attr("class","mp-name");
    mp.append("span").attr("class","mp-values");

    var majority = constInfo.append("div")
        .attr("class","majority");
    majority.append("span").attr("class","majority-label").text("Majority");
    majority.append("span").attr("class","majority-values");

    var swing = constInfo.append("div")
        .attr("class","swing");
    swing.append("span").attr("class","swing-label").text("Swing");
    swing.append("span").attr("class","swing-values");

    var turnout = constInfo.append("div")
        .attr("class","turnout");
    turnout.append("span").attr("class","turnout-label").text("turnout");
    turnout.append("span").attr("class","turnout-values");
  }

  // INIT
  // Appends a couple of divs to get responsive behaviour, then
  // just decides whether we're 'small' or 'big' and builds accordingly...
  my.init = function() {
    var resizeTimer;
    // Set the resize event watcher on the window:
    d3.select(window).on('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(frameworkResize, 100);
    });
    mnvWidget = d3.select(".mnv-map-uk-election-2017-election-night");
    // Double-wrapper structure is necessary for responsive height : width
    mainWrapper = mnvWidget.append("div")
      .attr("class","ukelmap-outer-wrapper")
        .append("div")
        .attr("class","ukelmap-main-wrapper")
    ;
    // Function to build further down the hierarchy...
    buildFramework();
  };
  // INIT ends

  // UPDATE
  // This would allow us to update the header with any headline values
  my.update = function() {
    var totals, headerString;
    return;
    totals = "";
    headerString = model.strings.title;
    headerString += totals;
    d3.select(".ukelmap-titlestring-div").html(headerString);
  };
  // UPDATE ends


  return my;
}());
// FRAMEWORK constructor ends

"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

mnv_ukelmap.utilities = (function() {
  var my = {};

  // Return true = touch based devices.
  my.isTouchDevice = function() {
    return (window.ontouchstart !== undefined || window.navigator.msMaxTouchPoints);
  };

  // Return true if the object passed is empty. jQuery from version 1.4 has implemented the isEmptyObject(object) method
  // (http://api.jquery.com/jQuery.isEmptyObject/) when/if we update the jQuery library this function can be replaced
  // with the isEmptyObject method.
  my.isEmptyObject = function(o) {
    for(var p in o) {
      if(o.hasOwnProperty(p)) {
        return false;
      }
    }
    return true;
  };

  // Check for *version* of IE
  my.IE = function(version) {
    var ie = (navigator.appName.search("Explorer") >= 0) ? true : false;
    var ver = (typeof version === 'number') ? [version] : version;
    if (ie && ver) {
      for(var key in ver) {
        ie = (navigator.appVersion.search('MSIE ' + ver[key] + '.0') >= 0) ? true : false;
        if (ie === true){break;}
      }
    }
    return ie;
  };

  // NUMBER WITH COMMAS
  // Found this out there somewhere. Converts number to '000 format,
  // without screwing up decimal places, and returns as a string:
  my.numberWithCommas = function(n) {
    "use strict";
    var parts=n.toString().split(".");
    return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + (parts[1] ? "." + parts[1] : "");
  };  

  my.log = function(txt){
    if(window.console && window.console.log){
      // console.log(txt);
    }
  };
  // NUMBER WITH COMMAS ends

  // RECURSIVE PARENT SIZE SEARCH
  my.recursiveParentSizeSearch = function(el, recursiveLimit, recursiveDepth){
    var sizes, sizeObj = {};
    // On first call, set to zero
    if (recursiveDepth === undefined) { recursiveDepth = 0; }
    // If we've reached the depth limit, return undefined:
    if(recursiveDepth===recursiveLimit){
      //console.log("Unable to find a plausible parent...");
      return;
    }
    // Still here? Look for viable size at this depth:
    sizes = el.parentElement.getBoundingClientRect();
    if(sizes.width!==0 && sizes.width){
      sizeObj.height = sizes.height;
      sizeObj.width = sizes.width;
      // If we've got dimensions, return them:
      // console.log('Detected sizes from wrapper w:' + sizes.width + ' h:' + sizes.height);
      return sizeObj;
      //return {"width":sizes.width, "height":sizes.height};
    }
    else {
      // No luck yet, bubble up...
      // console.log('Unable to detect sizes on' + el + ' I will try with ' + el.parentElement );
      return my.recursiveParentSizeSearch(el.parentElement, recursiveLimit, recursiveDepth++);
    }
    // 
    // recursiveLimit++;
  };
  // RECURSIVE PARENT SIZE SEARCH ends


  return my;
  
}());

/*
  Module is responsible for general wrapper
*/
"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

// DROPDOWNS constructor
mnv_ukelmap.dropdowns = (function(){
  var my, model, controller;
  my = {};
  controller = mnv_ukelmap.controller;
  model = mnv_ukelmap.model;

  // LOCAL FLAGS
  my.localflags = {
  };
  // LOCAL FLAGS ends

  // *** UMBERTO'S DROPDOWNS

  // CREATE TABS
  // Called from the INIT function.
  // Passed the tab definition and the DOM container; and an index identifying type (topics, zoom...)
  function createTabs (tabs, appendTo, eventListener) {
    // Build tabs and sub-menus.
    function createLevel(tabs, className, selected){
      var tabsTree = '<ul class="' + ((className) ? "ec-interactive-dropdowns" : "") +'">', tabsTreeChild, s = '', childClass, tabLength = 0;
      for (s in tabs) {
        tabsTreeChild = '';
        if (tabs.hasOwnProperty(s)) {
          if (!mnv_ukelmap.utilities.isEmptyObject(tabs[s].children)) {
            childClass = 'has-child';
            // Recursion
            tabsTreeChild = createLevel(tabs[s].children);
          } else {
            childClass = 'has-nochild';
          }
          // Default selected:
          if ((selected!==undefined && tabLength === selected) || (selected===undefined && tabLength === 0)) {
            childClass += ' selected';
          }
          tabsTree +=  '<li class="' + childClass + '"><span>' + tabs[s].label + '</span>' + tabsTreeChild + '</li>';
        }
        tabLength ++;
      }
      tabsTree += '</ul>';
      return tabsTree;
    }
    appendTo.append(createLevel(tabs, "ec-interactive-dropdowns", model.flags.topic_index));
    interactiveDropdowns(eventListener);
  }


  // INTERACTIVE DROPDOWNS
  // Called from createTabs. Param is the name of the callback function
  function interactiveDropdowns(callFunction) {
    var $this, $thisElm, cssTransitions, dropdownsMenu, showDropdowns;
    // Css transitions support. This relys on the Modernizr library.
    cssTransitions = $('.csstransitions').length;
    dropdownsMenu = $('.ec-interactive-dropdowns');

    showDropdowns = function () {
      $this = $(this);
      if (cssTransitions) {
        //$('.show-menu', dropdownsMenu).removeClass('show-menu');
        $this.addClass('show-menu');
      }
      else {
        // Show its submenu.
        $('ul', $this).css('display', 'block');
      }
    };

    // Set events on menu drop-downs.
    // Mouse over/out on topic menu tabs and zoom button shows/hides dropdowns.
    if (mnv_ukelmap.utilities.isTouchDevice()) {
      $('li.has-child', dropdownsMenu).click(showDropdowns);
    } else {
      $('li.has-child', dropdownsMenu).mouseenter(showDropdowns);
      $('li.has-child', dropdownsMenu).mouseleave(
      function () {
        $this = $(this);
        if (cssTransitions) {
          $this.removeClass('show-menu');
        }
        else {
          // Hide its submenu.
          $('ul', $this).css('display', 'none');
        }
      });
    }

    // Click on dropdown hides it.
    $('li:not(.has-child)', dropdownsMenu).click(function () {
      var $this, parent, getParentIndex;
      $this = $(this);
      parent = $this.parents('.ec-interactive-dropdowns');
      getParentIndex = $('.ec-interactive-dropdowns li:not(".has-child")').index(this);
      hideMenu($('li', dropdownsMenu));
      $('li, li.has-nochild', parent).removeClass('selected');
      $thisElm = ($this.hasClass('has-nochild')) ?  $this : $this.parents('li');
      $thisElm.addClass('selected');
      if(callFunction !== undefined) {
        callFunction(getParentIndex);
      }
    });

    // The menu gets hid.
    function hideMenu(menu) {
      if (!cssTransitions) {
        // Jquery.
        $('ul', menu).slideUp(10);
      }
      else {
        // CSS3 transitions.
        menu.removeClass('show-menu');
      }
    }
  }

  // *** UMBERTO'S DROPDOWNS END

  // INIT
  my.init = function() {
    var tabs, topicdiv;
    tabs = model.tabs;
    topicdiv = $(".ukelmap-topic-div");
    createTabs(tabs,topicdiv,controller.dropdownListener);
  };
  // INIT ends

  // UPDATE
  my.update = function() {
    var tabs, topicdiv, timeStamp, liveTime;

    // To prevent unnecessary redraws, what's current situation?
    // Crude check on first id:
    var currentID = model.tabs[0].id;
    // Go-live time check
    // UTC time now:
    timeStamp =  Date.now();
    // 'Go-live' time:
    var liveTime = model.goliveTime;
    // If it's after 'go-live' time, redirect model.tabs to livetab definitions
    if (timeStamp > liveTime) {
      model.tabs = model.livetabs;
      // Prevent any further update...
      model.startchecks.big.dropdowns.update = false;
    }
    // Redraw the tab-bar (emptying its parent first)
    tabs = model.tabs;
    // So have things changed?
    if (tabs[0].id !== currentID) {
      topicdiv = $(".ukelmap-topic-div");
      topicdiv.empty();
      createTabs(tabs,topicdiv,controller.dropdownListener);
      // And force update to new tab's data...
      controller.dropdownListener(0);
    }
  };
  // UPDATE ends

  return my;
}());
// DROPDOWNS constructor ends


/*
 * These are just the constituent elements of an inline tab-assembly process.
 * Two objects are hard-defined here as variables to be passed to the function createTabs
 *    var tabs should be the tab-definition in the model
 *    var appendTo should be the DOM object to which the tab is appended
 *
 * function createTabs should be called from the INIT function, and passed the two above objects
 *
 * So to get this working, I need to call createTabs from my INIT function, passing in the tabs definition
 * on the model, and the DOM container
 * I also need to add, somewhere, code to set the width%, based on the number of tabls
 * *** And tweak to distinguish between topic-tabs, zoom and any other tab structure (like currencies on Big Mac) ***
 */


/*
// APPEND_TO
// This stands in for a reference to the container on the DOM
var demo_appendTo = $('#ec-article-body');
// APPEND_TO ends
*/

/*
  Module is responsible for KEYS
*/
"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

// KEYS constructor
mnv_ukelmap.keys = (function(){
  var my, model, controller, parties, modelflags, kUL, kWidth, kHeight, kSVG,
    kGroup, mapindex, dataindex, keyTitle;
  my = {};
  model = mnv_ukelmap.model;
  controller = mnv_ukelmap.controller;
  parties = model.parties;
  modelflags = model.flags;

  // LOCAL FLAGS
  my.localflags = {
    mapindex: -1,
    dataindex: "dataindex",
    currentconstit: "currentconstit",
    updatecounter: -1
  };
  // LOCAL FLAGS ends

  function keymouseover() {
    var id = this.id.split("_")[1];
    controller.keyListener(id);
  }

  // INIT
  // Just appends the ul component to the key div
  my.init = function() {
    var keyWrapper = d3.select('.ukelmap-keys-div');

    keyWrapper.append("button")
      .attr("class","closer")
      .on("click", function(){
        mnv_ukelmap.framework.inViewKey(false);
      });

    keyTitle = keyWrapper.append("div")
      .attr("class", "ukelmap-keys-label")
      .style("padding-bottom","5px");

    kUL = keyWrapper.append("ul")
       .attr("class","ukelmap-keys-ul")
       ;
    if(controller.isSmallVersion()){
      kUL.on("click", function(){
        mnv_ukelmap.framework.inViewKey(false);
      });
    }
    // Flag that framework is ready...
    controller.startchecks('keys');
  };
  // INIT ends


  // UPDATE
  // Compares local flags with the model
  // If there are any relevant differences, call drawKeys.
  // And update local flags
  my.update = function() {
    var constitavailable, mapI, dataI, changed, currentconstit,
      updatecounter;
    constitavailable = modelflags.constitavailable;
    currentconstit = modelflags.currentconstit;
    updatecounter = modelflags.updatecounter;

    mapI = modelflags.mapindex;
    dataI = modelflags.dataindex;
    changed = false;

    // When the datafilter responds to the map's request to find data for 1 constit
    // (either loaded from file, or available in model.data)...
    // If there IS a constit id (ie we're not looking for a national seat count),
    // and if the datafilter set the not-available flag, bale out now.
    if ( (currentconstit !== undefined) &&
         (!constitavailable) ) {
      showUndeclared(dataI);
      return;
    }

    // Map index:
    if (my.localflags.mapindex !== mapI) {
      my.localflags.mapindex = mapI;
      changed = true;
    }
    // Data index:
    if (my.localflags.dataindex !== dataI) {
      my.localflags.dataindex = dataI;
      changed = true;
    }
    if (changed) {
      my.drawKeys();
    }
    // Key strings:
    if ( (dataindex === "sev") || (dataindex === "fif") || (dataindex === "ten") ) {
      // If we're swapping tabs, 2010/15/17 and the widget has to
      // go off and load the file for the selected constit, we
      // just need to give that a mooment to complete...
      setTimeout( function() {
        my.appendPercentVals(currentconstit, dataindex);
      },0)
    }
    my.localflags.currentconstit = currentconstit;
  };
  // UPDATE ends

  // SHOW UNDECLARED
  // Relabels to party names only
  function showUndeclared(dataindex) {
    my.appendPercentVals(undefined,dataindex)
  }

  // New version of APPEND PERCENT VALS adds classes for sorting...
  my.appendPercentVals = function(id, dataindex) {
    var data, turnout, p, myP, kPrefix, thisP, kStr, v, kNo, kArray, temp, thisKey;
    kPrefix = "#key_";
    if (id !== undefined) {
      // Constit
      if (dataindex === "sev") {
        data = model.data.singleResults2017[id];
      } else if (dataindex === "fif") {
        data = model.data.singleResults2015[id];
      } else {
        data = model.data.singleResults2010[id];
      }
      if (data === undefined) {
        return;
      }
      turnout = data.turnout;
      d3.select(".ukelmap-keys-label")
        .text("Percent of vote");
    }
    else {
      // Seat count
      if (dataindex === "sev") {
        data = model.results2017;
      } else if (dataindex === "fif") {
        data = model.results2015;
      } else {
        data = model.results2010;
      }
      d3.select(".ukelmap-keys-label")
        .text("Seats");
    }
    // Array for sorting parties
    kArray = [];
    // Loop by parties. Pack an array with objects containing id, display-name, and val
    for (p in parties) {
      if (parties.hasOwnProperty(p)) {
        temp = {};
        thisP = parties[p];
        id = thisP.id;
        temp.id = id;
        kStr = thisP.keyname;
        v = data[id];
        // vote0 as % of turnout
        if (!isNaN(v)) {
          if (turnout === undefined) {
            // Default 'seats'
            if (v === 1) {
              kStr += ": " + v; // + " seat";
            }
            else {
              kStr += ": " + v; // + " seats";
            }
          }
          else {
            // Constit results:
            kStr += " " + (v / turnout * 100).toFixed(1) + "%";
          }
        }
        else {
          // "na" seats have zero val for sorting
          v = 0;
        }
        temp.val = v;
        temp.display = kStr;
        kArray.push(temp);
      }
    }
    // Now sort:
    kArray.sort(function(a,b) { return b.val - a.val; });

    for (kNo = 0; kNo < kArray.length; kNo ++) {
      thisKey = kArray[kNo];
      d3.select("#key_" + thisKey.id)
        .text(thisKey.display)
        .attr("class", function() { return "ukelmap-keys-li key_" + kNo})
        ;
    }
  };

  // DRAW KEYS
  // I'm getting map and data index. One of these may be redundant in the long term...
  my.drawKeys = function() {
    var kLookup, prefix, data, ulWidth, liWidth, keys, dLen;
    // USING MAP INDEX FOR NOW,
    // BUT MAY NEED TO BE DATA INDEX...
    // These 2 vars are globals, btw:
    mapindex = model.flags.mapindex;
    dataindex = model.flags.dataindex;
    // Delete any existing key 'li' components
    // (This provides for tabbed widgets...)
    d3.select('.ukelmap-keys-ul').selectAll("li").remove()
    // Ranges definitions -- using map index for now, but may need to be data index *** *** ***
    kLookup = model.keys[dataindex];
    // kLookup is an object defining ranges
    // Current and marginals just use a lookup property id and get
    //    the colour by looking that id up in parties
    // Demographics loop through by val, then look up display and fill properties

    // Prefix for key id
    prefix = model.strings.keyPrefix;
    // If a keyTitle is specified use this to update the legend title
    if(kLookup.keyTitle!== undefined){
      keyTitle.text(kLookup.keyTitle);
    }
    // Which key range? If we set smallranges = null on the model,
    // use bigranges...
    if (controller.isSmallVersion()) {
      if (kLookup.smallranges === null) {
        data = kLookup.bigranges;
      }
      else {
        data = kLookup.smallranges;
      }
    }
    else {
      data = kLookup.bigranges;
    }
    // I'm drawing a series of divs with 2 sub-elements: a rect and a text string...
    // Calculate width as % (for responsiveness), allowing for margins
    // (.5% padding, left and right of each key)
    // THESE AREN'T ACTUALLY APPLIED: COMM'D OUT ABOUT 15 LINES DOWN
    ulWidth = 100 - kLookup.layout.columns;
    liWidth = (ulWidth / kLookup.layout.columns) + "%";
    // Kludge!!!
    liWidth = "80%";

    dLen = data.length - 1;

    keys = kUL.selectAll('.ukelmap-keys-ul')
      .data(data)
      ;

    keys
      .enter().append("li")
      .attr("class",function(d,i) {
        var s = "ukelmap-keys-li key_"
        s += dLen - i;
        return s;
      })
      .attr("id", function(d,i) {
        var id;
        if ( (dataindex === "sev") || (dataindex === "fif") || (dataindex === "ten") ) {
          id = d.id;
        }
        else {
          id = i;
        }
        return prefix + id;
      })
      // .style("width",liWidth)
      .style("border-left-color", function(d,i) {
        var col;
        if ( (dataindex === "sev") || (dataindex === "fif") || (dataindex === "ten") ) {
          col = parties[d.id].colour;
        }
        else {
          col = data[i].fill;
        }
        return col;
      })
      .text(function(d) {
        if (dataindex === "brx") {
          return d.display;
        }
      })
      // Text is now supplied by appendPercentVals, called from update
      // .html(function(d){
      //   var party = parties[d.id];
      //   return party.keyname;
      // })
      // .on("mouseover",keymouseover)
    ;

  };
  // DRAW KEYS ends

  return my;
}());
// KEYS constructor ends

"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

// MAP
mnv_ukelmap.map = (function(){
  var my, model, modelFlags, controller;
  // Internal 'globals'
  var mapWrapper, mapWidth, mapHeight, mapSVG, mapOcean, mapGroup, hoverGroup, surfaceRatio, mapRatio,
    projection, path, mapindex, dataindex, mapDetails, mapGroupSize, mapSource, searchField,
    zoomGroup, scaledBy, centerOnContainer, groundMapWrapper, widgetContainer, preloader;
  var centroids = {};
  var nodrag = false;
  // Functions
  var cloneMapPath, cloneBlob, d3clone, arc, pie, oceanMouseOver, mapDone,
    pathClickFcn, getPath, zoom;
  my = {};
  model = mnv_ukelmap.model;
  modelFlags = model.flags;
  controller = mnv_ukelmap.controller;
  preloader = new Widget();

  // LOCAL FLAGS
  my.localflags = {
    mapindex: -1,
    dataindex: "dataindex",
    currentconstit: undefined,
    zoomconstit: "zoomconstit",
    // hexFlag denotes CURRENT state
    hexflag: true,
    canzoomout: false,
    literalmaploaded: false,
    updatecounter: -1,
    // switching is set to true while we're swapping literal/schematic
    // to prevent getting interrupted by recolour
    switching: false
  };
  // LOCAL FLAGS ends

  my.scaleStrokes = {
    1: {map: 1, hover: 2},
    2: {map: 0.5, hover: 1},
    4: {map: 0.25, hover: 0.5},
    10: {map: .1, hover: .2},
    25: {map: .1, hover: .2},
    50: {map: .1, hover: .2}
  }

  // Some temporary hard-coded flags:
  var myEase = "sin";
  // transition speed
  var mySpeed = 2000;
  var hexOrigin = {x:0,y:0};

  // ZOOM as called on mouse-wheel or drag
  zoom = function() {
    var transBy, mapStroke, hoverStroke, mapW, mapH, mapX, mapY;
    scaledBy = d3.event.scale;
    transBy = d3.event.translate;
    mapStroke = 1 / scaledBy + "px";
    hoverStroke = 2 / scaledBy + "px";

    var se = d3.event.sourceEvent;

    mapGroup
      .attr("transform", "translate(" + transBy + ")scale(" + scaledBy + ")")
      .style("stroke-width",mapStroke)
      ;
    hoverGroup
      .attr("transform", "translate(" + transBy + ")scale(" + scaledBy + ")")
      //.style("stroke-width",hoverStroke)
      ;
    d3.selectAll(".mappath-hover").style("stroke-width",hoverStroke);

  };
  // ZOOM ends


  // CLONE MAP PATH
  // Cannibalised from: http://stackoverflow.com/questions/18517376/d3-append-duplicates-of-a-selection
  cloneMapPath = function(pathID) {
    var id, p, sw;
    // Kill any existing highlight
    d3.selectAll(".mappath-hover").remove();
    // If no path has been selected, pathID is empty, so:
    if (pathID.length > 0) {
      // Map path
      id = "#" + pathID;
      p = d3clone(id, "mappath-hover");
      sw = (2 / scaledBy) + "px"
      d3.selectAll(".mappath-hover").style("stroke-width",sw).style('fill', 'none');
    }
  };
  // CLONE MAP PATH ends

  // D3 CLONE
  d3clone = function(selector, myClass) {
    var oNode, pNode, cNode;
    oNode = d3.select(selector).node();
    //console.log(oNode);
    pNode = hoverGroup.node();
    cNode = pNode.appendChild(oNode.cloneNode(true));
    pNode.childNodes[0].className.baseVal = myClass;
  };
  // D3 CLONE ends

  // PATH CLICK FCN
  // Called from path click
  pathClickFcn = function(id) {
    var data = model.data.results2010Obj;
    // If there's (2010) matching data, clone the DOM element
    if (data[id] !== undefined) {
      cloneMapPath(id);
    }
    // Remember rolled-over id
    model.flags.currentid = id;
    // Pass event to controller:
    controller.pathClickListener(id);
  };
  // PATH CLICK FCN

  // GET PATH
  getPath = function(d) {
    var id, path;
    id = d.id;
    if (my.localflags.hexflag) {
      // Hex refers to the constit lookup file
      path = oneHexPath(d.id);
    }
    else {
      // 'Raw' geographic path
      // path =  mapSource[d.id].d;
      path =  model.data.literalPathsObj[d.id].d;
    }
    return path;
  };

  // Event dispatcher
  my.dispatch = d3.dispatch("load");

  // LOAD MAP
  // Loads a new map but doesn't colour it...
  my.loadMap = function() {
    var mapWidth, scale, rawData, path,
      constituencyLookupData;
    mapindex = modelFlags.mapindex;
    dataindex = modelFlags.dataindex;
    // Data is raw data
    // rawData = model.data.results2010Array;
    rawData = model.data.constituencyLookupArray;
    constituencyLookupData = model.data.constituencyLookupObj;

    // Get hex flag
    if (my.localflags.hexflag) {
      // For hex coords:
      mapSource = model.data.constituencyLookupObj;
    }
    else {
      // Literal path
      mapSource = model.data.literalPathsObj;
    }

    // OK: haul in the data...
    // Bind data. Note that this isn't the path.
    // It currently defines only an ID; although
    // it may subsequently acquire other properties,
    // including result values and a winner-colour
    // (which'd have to be set in datafilter...)
    path = mapGroup.selectAll("path")
      .data(rawData)
    ;

    // Enter:
    path.enter().append("path")
      .attr("class","mappath")
      .style("fill",function(d) {
        var fill = "#DDDDDD";
        return fill;
      })
      .attr("id", function(d) {
        return d.id;
      })
      // And set event handler for click
      .on("click", function(d) {
        //if(!controller.isSmallVersion()){
          var id = d.id;
          pathClickFcn(id);
        //}
      })
      ;

    // Update:
    path
      // Default path:
      .attr("d", function(d) {
        return(getPath(d));
      })
    ;

    // Exit:
    path.exit().remove();

    // Size of map groups:
    mapGroupSize = mapGroup.node().getBBox();
    // Apply centering of an element into its container
    centerOnContainer.call(groundMapWrapper, mapWrapper);
    my.dispatch.load();
  };
  // LOAD MAP ends

  centerOnContainer = function(container){
    var innerElSizes = this.node().getBoundingClientRect(), x, containerWidth;
    containerWidth = parseInt(container.style("width"),10) - parseInt(container.style("padding-right"),10) - parseInt(container.style("padding-left"),10);
    x = (containerWidth - innerElSizes.width)/2;
    if (my.localflags.hexflag) { x /= 10; }
    this.attr('transform', 'translate(' + x + ', 0)');
  };

   // UPDATE
  // Compares local flags with the model
  // If there are any relevant differences, call loadMap to
  // draw a map.
  // And update local flags to match model
  my.update = function() {
    var modelflags, mapI, dataI, currentconstit, zoomconstit, mapchanged,
      datachanged, updatecounter;
    modelflags = model.flags;
    mapI = modelflags.mapindex;
    dataI = modelflags.dataindex;
    currentconstit = modelflags.currentconstit;
    zoomconstit = modelflags.zoomconstit;
    updatecounter = modelflags.updatecounter;
    // 2 flags:
    mapchanged = false;
    datachanged = false;
    // Has basic live data reloaded? 2017 map only...
    // ...and not if we're in mid-switch literal/schematic
    if (my.localflags.updatecounter !== updatecounter) {
      if ( (dataI === "sev") && !my.localflags.switching ) {
        my.localflags.updatecounter = updatecounter;
        datachanged = true;
      }
    }
    // Map index:
    if (my.localflags.mapindex !== mapI) {
      my.localflags.mapindex = mapI;
      mapchanged = true;
    }
    // Data index:
    if (my.localflags.dataindex !== dataI) {
      my.localflags.dataindex = dataI;
      datachanged = true;
    }
    if (mapchanged) { my.loadMap(); }
    if (datachanged) {
      my.colourMap(dataI);
    }
    // Zoom
    if (my.localflags.zoomconstit !== zoomconstit) {
      my.localflags.zoomconstit = zoomconstit;
      if (zoomconstit !== undefined) {
        my.zoomToConstit(zoomconstit);
      }
      else {
        if (my.localflags.canzoomout) {
          my.zoomToDefault();
        }
      }
    }
  };

  // UPDATE ends


  // INIT
  // Absolute basic foundations for maps. Creates:
  //    map svg object,
  //    ocean rect,
  //    map-group (to contain paths)
  //    hover-group (for highlights)
  // Then tells controller we're ready for whatever comes next...
  my.init = function() {
    var vbSize;
    // Existing wrapper
    mapWrapper = d3.select('.ukelmap-map-div');
    widgetContainer = d3.select('.mnv-map-uk-election-2017-election-night');
    (my.localflags.hexflag) ? widgetContainer.classed("map-hex", true) : widgetContainer.classed("map-uk", true);
    mapWrapper.classed("")
    appendSearchField.call(mapWrapper);
    mapWidth = parseInt(mapWrapper.style("width"),10);
    mapHeight = parseInt(mapWrapper.style("height"),10);
    scaledBy = 1;

    // Tweak hexOrigin for map size...
    if (controller.isSmallVersion) {
      hexOrigin.x = 40;
      hexOrigin.y = 0;
    }
    else {
      hexOrigin.x = 0;
      hexOrigin.y = 0;
    }

    // Remember ratio in a module-global (for resize, see below):
    surfaceRatio = mapWidth/mapHeight; // Actual w/h of map container
    mapRatio = 0.6666;                 // map artwork w/h

    if (mapRatio > surfaceRatio) {
      // If artwork is disproportionatel wide
      vbSize = mapWidth;
      mnv_ukelmap.utilities.log("Went with width of " + vbSize);
      if (vbSize < 310) {
        vbSize = 310;
        mnv_ukelmap.utilities.log("Tweaked to " + vbSize + " to squeeze!");
      }
    }
    else {
      vbSize = mapHeight * mapRatio;
      //mnv_ukelmap.utilities.log("Went with height of " + vbSize);
    }


    // SVG arenas
    mapSVG = mapWrapper.append("svg")
      //.attr("width", mapWidth)
      //.attr("height", mapHeight)
      .attr("width", "100%")
      .attr("height", "100%")
      //.attr("transform","scale(" + scaledBy + ")")


      //.attr('viewBox', '0 0 ' + Math.min(mapWidth, mapHeight) + ' ' + Math.min(mapWidth, mapHeight))
      //.attr('viewBox', '0 0 ' + mapWidth*1 + ' ' + mapHeight*2)
      .attr('viewBox', '0 0 ' + vbSize + ' ' + vbSize)
      .attr('preserveAspectRatio','xMinYMin')
      ;

    // zoomGroup = mapSVG.append("g")
    //   .call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoom))
    //   ;

    // Ocean
    mapOcean = mapSVG.append("rect")
      .attr('id','ocean')
      .attr("class", "ocean")
      .attr("width", mapWidth)
      .attr("height", mapHeight)
      .on("click", function(){
        d3.selectAll(".mappath-hover").remove();
        // Pass event to controller
        controller.oceanClickListener();
        mnv_ukelmap.framework.viewConstituency( false );
      })
      ;
    groundMapWrapper  = mapSVG.append("g")
      .attr('id','mapgroundwrapper')
      ;
    // SVG group
    mapGroup = groundMapWrapper.append("g")
      .attr('id','mapgroup')
      ;
    // Hover group: on mouseover, the cloned, outlined
    // path is created in this group
    hoverGroup = groundMapWrapper.append("g")
      .attr('id','hovergroup')
      ;

    // Call for zoom (last, but doesn't have to be):
    // mapSVG
    //   .call(d3.behavior.zoom()
    //   .scaleExtent([1, 10])
    //   .on("zoom", zoom))
    //   ;
    // mapSVG
    //   //.call(d3.behavior.zoom()
    //   //.scaleExtent([1, 10])
    //   .on("mousedown.zoom",null)
    //   .on("mousedown.drag", null)
    //   .on("touchstart.drag",null)
    //   .on("touchmove.drag",null)
    //   .on("touchend.drag",null)
    // ;


    // Crude append of toggle button:
    //appendToggleButton();

    // Flag that framework is ready...
    controller.startchecks('map');

  };
  // INIT ends
  // Add Livesearch field
  function appendSearchField(){
    var searchField = this.append("div");
    searchField.attr("data-mnv","ecLiveSearch");
    searchField.attr("class","mnv-ec-livesearch");
    // Listener for data loaded event
    my.dispatch.on("load", my.initSearchField );
    // Add listeners to the widget related function
    searchField[0][0].addEventListener('resultSelected', function(e){
      var detail = e.detail;
      //console.log(d3.select(".view-constituency"));
      mnv_ukelmap.framework.viewConstituency(true);
      // Pass constituency id to controller:
      controller.liveSearchSelectionListener(detail.id);
    });
    // Append Key button for smal version
    this.append("button")
      .attr("class","toggle-views-btn toggle-views-key")
      .on("click", function(){
        mnv_ukelmap.framework.inViewKey(true);
      })
      .text("See all parties");
    /*
    searchField[0][0].addEventListener('fieldReset', function(e){
      var detail = e.detail;
      console.log(detail)
      return;
      mnv_ukelmap.framework.viewConstituency(false);
      // Pass constituency id (or undefined) to controller:
      controller.liveSearchSelectionListener(undefined);
    });
    */

  }
  // Init searchField
  my.initSearchField = function initSearchField(){
    var  config, liveSearchCmp;
    config = {
      // list: mnv_ukelmap.model.data.results2010Array,
      // searchProperty: "constituency_name",
      list: mnv_ukelmap.model.data.constituencyLookupArray,
      searchProperty: "name",
      hideOnLeave: true,
      placeholder: "Search by constituency"
    };
    // Create the liveSearch obj
    liveSearchCmp = new ecLiveSearch(config);
  }

  // APPEND TOGGLE BUTTON
  function appendToggleButton() {
    mapWrapper.append("div")
      .attr("class","toggle-div")
      .append("input")
        .attr("class","toggle-input")
        .attr("name","toggleButton")
        .attr("type","button")
        .on("click", toggleListener() )
        .attr("value", function() {
          var s;
          if (my.localflags.hexflag) {
            s = "Literal";
          }
          else {
            s = "Schematic";
          }
          return s;
        });
  }
  // APPEND TOGGLE BUTTON ends

  // LOAD LITERAL PATHS
  // is called from toggleListener, below, if there are no literal paths in model.data
  // Calls function in datafilter (ouch! but these are desperate times!!) to do the dirty work.
  // Callback from datafilter will call toggleListener again, with the flag
  function loadLiteralPaths() {
    // To prevent silliness, disable the toggle button
    d3.select(".toggler").style({
      "opacity":0.3,
      "pointer-events":"none"
      });
    // Show preloader:
    preloader.el = $('.ukelmap-map-div');
    preloader.addPreloader();
    // And call the datafilter for the data:
    mnv_ukelmap.datafilter.loadLiteralData();
  }
  // LOAD LITERAL PATHS

  // TOGGLE LISTENER is called by button click to toggle map style (literal/symbolic)
  my.toggleListener= function(flg) {
    if (flg === 'mobile') {
      drawHexPaths();
      my.localflags.hexflag = true;
    }
    else {
      // Set flag to DESIRED STATE (!current)
      var flag = !my.localflags.hexflag;

      // Kill any existing highlight
      d3.selectAll(".mappath-hover").remove();
      if (flag) {
        // So desired state is hex
        drawHexPaths();
      }
      else {
        // Desired state is literal
        // But do we have literal data?
        if (model.data.literalPathsObj === undefined) {
          // If not, we go off and load them. A callback
          // drops us back here, when the object should exist...
          loadLiteralPaths();
          return;
        }
        else {
          // There are literal paths in the model, so use them...
          drawLiteralPaths();
        }
      }
      // Toggle flag
      my.localflags.hexflag = flag;
    }
  }
  // TOGGLE LISTENER ends

  function drawHexPaths() {
    var data, i, id;
    data = model.data.constituencyLookupArray;
    my.localflags.switching = true;
    for (i = 0; i < data.length; i++) {
      id = data[i].id;
      oneHexPath(id, i);
    }
    widgetContainer
      .classed("map-hex", true)
      .classed("map-uk", false)
      ;

  }

  function drawLiteralPaths() {
    var data, i, id;
    data = model.data.constituencyLookupArray;
    my.localflags.switching = true;
    for (i = 0; i < data.length; i++) {
      id = data[i].id;
      oneLiteralPath(id, i);
    }
    widgetContainer
      .classed("map-hex", false)
      .classed("map-uk", true)
      ;
    // If this was first load, put everything right...
    if (!my.localflags.literalmaploaded) {
      // Reset toggler and remove preloader
      // (with timeout to match path transition time...)
      setTimeout(function(){
        d3.select(".toggler").style({
          "opacity":1,
          "pointer-events":"auto"
          });
        preloader.removePreloader();
          }, 2000);
      my.localflags.literalmaploaded = true;
    }
  }


  // MAP COLOURING FUNCTIONS
  // colourMap is called from update. According to dataIndex, forks to:
  //    simpleColour
  //    brexitColour
  // Each returns a fill value for a single path

  // SIMPLE COLOUR
  // Gets winning party's id from the data and looks up
  // its colour on the model
  function simpleColour(data) {
    var winner, party;
    winner = data.w;
    party = model.parties[winner];
    if (party !== undefined) {
      return party.colour;
    }
  }
  // SIMPLE COLOUR ends

  // BREXIT COLOUR
  // Arg is an object with props 'id' and 'val'
  function brexitColour(data) {
    var dIndex, remain, col, rangesArray, i;
    dIndex = model.flags.dataindex;
    remain = data.val;
    // By default:
    col = "#eeeeee";
    rangesArray = model.keys[dIndex].bigranges;
    for (i = 0; i < rangesArray.length; i ++) {
      if (data.val < rangesArray[i].val) {
        col = rangesArray[i].fill;
        break;
      }
    }
    return col;

    // var dIndex, id, val, rangesArray, i, col;
    // dIndex = model.flags.dataindex;
    // // Lookup string for this topic
    // id = my.localflags.dataindex;
    // // Get the value. If there isn't one, set to default:
    // val = data[id];
    // if (isNaN(val)) {
    //   return col;
    // }
    // else {
    //   // Still here? Look up in the ranges array for demographics
    //   rangesArray = model.keys[dIndex].bigranges;
    //   for (i = 0; i < rangesArray.length; i ++) {
    //     if (val < rangesArray[i].val) {
    //       //r = i;
    //       break;
    //     }
    //   }
    //   return rangesArray[i].fill;
    // }

  }
  // BREXIT COLOUR ends


  // COLOUR MAP
  // Handles colouring
  // Dataset index param is passed in, but not used...
  // For now, I'm hard-coded to filtered data
  my.colourMap = function(dIndex) {
    var data;
    if (dIndex === "sev") {
      data = model.data.results2017Obj;
    } else if (dIndex === "fif") {
      data = model.data.results2015Obj;
    } else if (dIndex === "ten") {
      data = model.data.results2010Obj;
    } else {
      data = model.data.resultsBrexitObj;
    }
    // console.log(data);
    // d3 loop through existing state paths setting colours:
    d3.selectAll('.mappath')
      .transition().duration(500)
      .style("fill",function(d){
        var id, luObj, fill;
        // Path id ("id" on actual DOM element; not "id");
        id = this.id;
        luObj = data[id];
        // Default fill:
        //fill = "#aaaaaa";
        fill = model.colours.undeclared;
        if (luObj !== undefined) {
          switch (dIndex) {
            case "sev":
              fill = simpleColour(luObj);
              break;
            case "fif":
              fill = simpleColour(luObj);
              break;
            case "ten":
              fill = simpleColour(luObj);
              break;
            case "brx":
              fill = brexitColour(luObj);
              break;
            default:
              fill = simpleColour(luObj);
          }
        }
        else {
          //console.log("Unable to find " + id + " to colour...");
        }
        return fill;
      })

    ;

  };
  // COLOUR MAP ends

  // *** HEX PATH FUNCTIONS ***


    // GET HEX POINTS
    // Called from redraw. Passed the row and column for
    // the hexagon, returns its six points as an array of
    // x/y coordinates
    var getHexPoints = function(c) {
      var hexArray, _s32, a, x, y, xFactor, yFactor, factor;
      // Relative to group:
      // uses hard-coded known row and col counts
     // if (mapGroupSize === undefined) {
     //   console.log("undefined")
        xFactor = mapWidth / 54;
        yFactor = mapHeight / 85;
        factor = Math.min(xFactor,yFactor);
      //}
      //else {
      //  console.log("defined")
        //xFactor = mapGroupSize.width / 54;
        //yFactor = mapGroupSize.height / 85;
      //   xFactor = mapGroupSize.width / 60;
      //   yFactor = mapGroupSize.height / 95;
      //   factor = Math.min(xFactor,yFactor);
      //   factor *= 2;
      // }

      // Tweak hex sizes for map size...
      if (controller.isSmallVersion) {
          factor *= 1.3;
      }
      else {
          factor *= 1.5;
      }

      hexArray = [];
      _s32 = (Math.sqrt(3)/2); // to draw hexagon
      a = factor/1.666; // size of each hexagon

      // x-centre-origin, with extra tweak to close up slightly
      //x = (c.x * factor*0.95) + hexOrigin.x;
      x = (c.x * factor*0.9) + hexOrigin.x;
      // y-centre-origin
      y = (c.y * factor*1.02) + hexOrigin.y;
      // y = mapGroupSize.height - y;
      // Even columns drop:
      if (c.x%2 === 0) { y -= factor/2; }
      // 6 points:
      hexArray[0] = (a+x) + "," + (0+y);
      hexArray[1] = (a/2+x) + "," + (a*_s32+y);
      hexArray[2] = (-a/2+x) + "," + (a*_s32+y);
      hexArray[3] = (-a+x) + "," + (0+y);
      hexArray[4] = (-a/2+x) + "," + (-a*_s32+y);
      hexArray[5] = (a/2+x) + "," + (-a*_s32+y);
      return hexArray;
    };
    // GET HEX POINTS ends


    // ONE HEX PATH
    // Called from drawHexPaths with id string as param.
    // Isolates the path and converts to a hexagon
    function oneHexPath(pid, counter) {
      var myPath, pArray, mainPath, longI, thisLen, i, j, bbox, c,
        hexPointArray, hexPathArray, sixthLen, ptNo, hexStr, aLen, pathD, hc,
        bbx, centArray;
      myPath = d3.select("#" + pid);
      // 1) MAIN PATH
      // Grab the path's "d" attribute. This may be a compound path,
      // so initally split into subpaths:
      pathD = myPath.attr("d");
      if (pathD === null) {
        // Get a centre point
        hc = {};
        hc.x = mapSource[pid].col;
        hc.y = mapSource[pid].row;
        // Prepare six points:
        hexPointArray = getHexPoints(hc);
        // Now I've got to re-stringify
        hexStr = "M" + hexPointArray.join("L") + "Z";

        // Botch centroids
        centArray = hexPointArray[0].split(",")
        centroids[pid] = {
          x: parseInt(centArray[0])-5,
          y: parseInt(centArray[1])
        }
      }
      else {
        // Path exists...
        pArray = pathD.split("M");
        // Now loop through subpaths and get index of longest
        longI = 0;
        thisLen = 0;
        for (i = 0; i < pArray.length; i ++) {
          if (pArray[i].length > thisLen) {
            thisLen = pArray[i].length;
            longI = i;
          }
        }
        // Isolate the longest path string
        mainPath = pArray[longI];
        // Redraw each element as main path only:
        myPath.transition().duration(mySpeed/2).attr("d","M" + mainPath);

        // MAYBE I could set a timeout here, just to allow the simplified path to
        // visually establish itself before we proceed to hex conversion...

        // 2) POINTS
        // Next array is by points in the main path:
        // Delete "Z" closure from path and split on "L"
        mainPath = mainPath.replace("Z","");
        pArray = mainPath.split("L");
        // Count points:
        aLen = pArray.length;

        // Centre point of main path:
        bbx = myPath.node().getBBox();
        c = {};
        c.x = bbx.x + (bbx.width/2);
        c.y = bbx.y + (bbx.height/2);
        // Reserve literal centres for later reset:
        centroids[pid] = {
          x: c.x, y: c.y
        }
        // Now reset centre point to desired hex centroid:
        hc = {};
        hc.x = model.data.constituencyLookupObj[pid].col;
        hc.y = model.data.constituencyLookupObj[pid].row;

        // Prepare six points:
        hexPointArray = getHexPoints(hc);
        // And an empty array for the reset path:
        hexPathArray = [];

        // Get a sixth of the length of the path
        sixthLen = Math.floor(aLen / 6);
        for (var j = 0; j < 6; j++) {
          for (i = 0; i < sixthLen; i ++) {
            ptNo = (j * sixthLen) + i;
            hexPathArray[ptNo] = hexPointArray[j];
          }
        }
        // console.log(pid + " has " + hexPathArray.length + " points");

        // Now I've got to re-stringify
        hexStr = "M" + hexPathArray.join("L") + "Z";

      }
      // And redraw
      myPath
        .transition().duration(mySpeed).attr("d",hexStr)
        ;
      if (counter === 649) {
        setTimeout( function() {
          my.localflags.switching = false;
          // And force any hover back
          redisplayHover();
        },mySpeed)
      }
      return hexStr;
    }
    // ONE HEX PATH ends

    function oneLiteralPath(pid, counter) {
      var path, litStr, hexStr, bbx, hexC, litC, transX, transY, pArray, onePt, pA, pStr, transStr, i;
      // Path object
      path = d3.select("#" + pid);
      // Literal string to which we'll transform...
      litStr = model.data.literalPathsObj[pid].d;
      //litStr = mapSource[pid].d;

      // First, move the hexagon
      // Hex centre point:
      bbx = path.node().getBBox();
      hexC = {};
      hexC.x = bbx.x + (bbx.width/2);
      hexC.y = bbx.y + (bbx.height/2);
      // And desired location (reserved in global)
      litC = centroids[pid];
      transX = litC.x - hexC.x;
      transY = litC.y - hexC.y;
      // Reset all points to move the hexagon into place
      // (this minimises the "jagged speech bubble" effect)
      // Break up the path and "transform" each x/y coord:
      pArray = path.attr("d").replace("M","").replace("Z","").split("L");
      for (i = 0; i < pArray.length; i ++) {
        onePt = pArray[i];
        pA = onePt.split(",");
        pA[0] = parseFloat(pA[0]) + transX;
        pA[1] = parseFloat(pA[1]) + transY;
        // Put back:
        pArray[i] = pA.join(",");
      }
      // Complete path for hexagon in changed location
      pStr = "M" + pArray.join(" L") + " Z";

      // Move the hexagon, then reset to literal path:
      path
        // Move
        .transition().duration(mySpeed/2).ease(myEase)
          .attr("d",pStr)
          // Move ends
          //
          // Redraw as literal
          // If I comment out next 4 lines, there's no literal transition
          .transition().duration(mySpeed/2).ease(myEase)
          .attr("d",function() {
            return litStr;
          })
          // Literal redraw ends
        ;
      // Reset flag to allow basic data update to recolour
    if (counter === 649) {
      setTimeout( function() {
        my.localflags.switching = false;
        // force any hover back
        redisplayHover();
      },mySpeed)
    }
  }

  // REDISPLAY HOVER
  // Called from oneSchematic/LiteralPath upon completion of
  // final redraw. Checks the current constit flag on the model
  // and clones the matching path
  function redisplayHover() {
    var constit;
    constit = model.flags.currentconstit;
    if (constit !== undefined) {
      cloneMapPath(constit);
      my.localflags.currentconstit = constit;
    }
  }
  // REDISPLAY HOVER

  // *** ZOOMING ***

  // ZOOM TO DEFAULT
  my.zoomToDefault = function() {
    var transStr, mapStroke, hoverStroke;
    scaledBy = 1;
    transStr = "translate(0,0)scale(" + scaledBy + ")";
    mapStroke = "1px";
    mapGroup
      .transition().duration(2000)
      .attr("transform", transStr)
      ;
    hoverGroup
      .transition().duration(2000)
      .attr("transform", transStr)
      ;
    // Stroke widths:
    d3.selectAll(".mappath").transition().duration(2500).style("stroke-width",mapStroke);
    d3.selectAll(".mappath-hover").remove();

    my.localflags.canzoomout = false;

    pathClickFcn();
    d3.select('#map-toggler')
      .attr('disabled', null);
    mnv_ukelmap.framework.isZoomed( false );
  }
  // ZOOM TO DEFAULT ends

  // ZOOM TO CONSTIT
  my.zoomToConstit = function(id) {
    var mapW, mapH, zoomPath, bbox, x1, x2, y1, y2,
      transX, transY, transStr, mapStroke, hoverStroke;
    if(controller.isSmallVersion()){
      return ;
    }
    // SCALE
    scaledBy = 5;
    // POSITION
    // Map container centre
    mapW = parseInt(mapSVG.style("width"));
    mapH = parseInt(mapSVG.style("height"));
    // Zoom target coords
    zoomPath = d3.select("#" + id);
    // bbox is an object with properties: x, y, width, height.
    // I need a centre point
    bbox = zoomPath.node().getBBox();
    x1 = bbox.x;
    y1 = bbox.y;
    x2 = x1 + bbox.width;
    y2 = y1 + bbox.height;

    scaledBy = .5 / Math.max ( ((x2 - x1) / mapW), ((y2 - y1) / mapH) );
    if (my.localflags.hexflag) {
      if (scaledBy > 10) {scaledBy = 10};
    }
    else {
      if (scaledBy > 25) {scaledBy = 25};
    }
    transX = ( mapW - scaledBy * (x1 + x2) ) / 2;
    transY = ( mapH - scaledBy * (y1 + y2) ) / 2;
    transStr = "translate(" + transX + "," + transY + ")scale(" + scaledBy + ")";

    // Scaling for strokewidth uses values hard-pulled from CSS
    mapStroke = 1 / scaledBy + "px";
    hoverStroke = 3 / (scaledBy) + "px";

    mapGroup
      .transition().duration(2000)
      .attr("transform", transStr)
      // .style("stroke-width",mapStroke)
      ;
    hoverGroup
      .transition().duration(2000)
      .attr("transform", transStr)

      ;
    // Stroke widths:
    d3.selectAll(".mappath").transition().duration(2000).style("stroke-width",mapStroke);
    d3.selectAll(".mappath-hover").transition().duration(2000).style("stroke-width",hoverStroke);
    // Highlight and pass on...
    pathClickFcn(id);
    my.localflags.canzoomout = true;
    d3.select('#map-toggler')
      .attr('disabled','disabled');
    mnv_ukelmap.framework.isZoomed( true );

  };
  // ZOOM TO CONSTIT ends

return my;
}());
// MAP ends

"use strict";
var mnv_ukelmap = mnv_ukelmap || {};

/*
Bostock's tremap is at:
https://strongriley.github.io/d3/ex/treemap.html
*/

// TREE MAP
mnv_ukelmap.treemap = (function(){
  var my, model, modelFlags, controller, parties, numberformat;
  // Internal 'globals'
  var tree, treeWrapper, treeWidth, treeHeight,
    treeMap, treeMapDiv, colChartDiv, colChartSVG, colChartGroup,
    colChartxScale, colChartyScale, position, node, cluster,
    svgH, svgW, xAxis, yAxis, xAxisEl, zeroline;
  // Constituency info globals
  var constInfo, region, constituency, party, partyname, partystatus,
    mpname, mpvalues, majoritylabel, majorityvalues, swinglabel,
    swingvalues, turnoutlabel, turnoutvalues;
  my = {};
  model = mnv_ukelmap.model;
  modelFlags = model.flags;
  controller = mnv_ukelmap.controller;
  parties = model.parties;
  numberformat = mnv_ukelmap.utilities.numberWithCommas;


  /*
  Code-cribbing...
    See: https://gist.github.com/alexandersimoes/7516456#file-tree_map_ex1-html
    And: http://d3plus.org/workshops/11_19_2013/tree_map/
  */

  // LOCAL FLAGS
  my.localflags = {
    currentconstit: "currentconstit",
    dataindex: "dataindex",
    updatecounter: -1
  };
  // LOCAL FLAGS ends

  // Dynamic code will have to mimic this structure
  /*tree = {
    id: "tree",
    children:[
      {"value":70, "id":"oth"},
      {"value":50, "id":"grn"},
      {"value":120, "id":"ukp"},
      {"value":40, "id":"lib"},
      {"value":220, "id":"lab"},
      {"value":250, "id":"con"}
      ]
  };*/

  // POSITION
  // Code to size and position nodes:
  position = function() {
    this
      .style("left", function(d) { return d.x + "px"; })
      .style("top", function(d) { return d.y + "px"; })
      .style("width", function(d) { return d.dx - 1 + "px"; })
      .style("height", function(d) { return d.dy - 1 + "px"; })
    ;
  };

  // ASSIGN CONSTITUENCY DOM ELEMENTS
  // Called from init: just ties elements to display constituency
  // info to internal globals, for easy reference...
  // All these elements were appended to the DOM in framework > appendConstituencyTemplate
  function assignConstituencyDOMelements() {
    constInfo = d3.select(".constituency-info");
    region = d3.select(".region");
    constituency = d3.select(".constituency");
    party = d3.select(".party");
    partyname = d3.select(".party-name");
    partystatus = d3.select(".party-status");
    mpname = d3.select(".mp-name");
    mpvalues = d3.select(".mp-values");
    majoritylabel = d3.select(".majority-label");
    majorityvalues = d3.select(".majority-values");
    swinglabel = d3.select(".swing-label");
    swingvalues = d3.select(".swing-values");
    turnoutlabel = d3.select(".turnout-label");
    turnoutvalues = d3.select(".turnout-values");
  }
  // ASSIGN CONSTITUENCY DOM ELEMENTS ends

  // INIT
  my.init = function() {
    var sizes, p, temp;

    // Assign internal globals to constit info elements
    assignConstituencyDOMelements();

    // Existing wrapper
    treeWrapper = d3.select('.ukelmap-treechart');
    // treeWidth = parseInt(treeWrapper.style("width"),10);
    // treeHeight = parseInt(treeWrapper.style("height"),10);
    sizes = mnv_ukelmap.utilities.recursiveParentSizeSearch(treeWrapper.node(),4);
    if (sizes !== undefined) {
      treeWidth = sizes.width;
      treeHeight = sizes.height;
    }
    else {
      treeWidth = 250;
      treeHeight = 300;
    }

    tree = {
      children: []
    }
    for (p in parties) {
      if (parties.hasOwnProperty(p)) {
        temp = {};
        temp.id = p;
        temp.value = 0;
        tree.children.push(temp);
      }
    }

    // var treemap = d3.treemap()
    //     .tile(d3.treemapSquarify.ratio(1))
    //     .size([width / ratio, height]);


    // Layout
    treeMap = d3.layout.treemap()
      .size([treeWidth,treeHeight])
      // Must be false to get update to work":"
      .sticky(false)
      // Sorts to drop from top-left to bottom-right
      // Comment out to sort the other way:
      .sort(function(a,b) {
          return a.id - b.id;
      })
      .value(function(d) {
        return d.value; })
      ;

    treeMapDiv = treeWrapper.append("div")
      .attr("class", "ukelmap-treemap-div")
    ;
    // And the column chart container
    colChartDiv = treeWrapper.append("div")
      .attr("class", "ukelmap-colchart-div")
    ;

    initColChart(colChartDiv);

    // Flag that framework is ready...
    controller.startchecks('treemap');
  };
  // INIT ends

  // RESIZE
  // Just reruns update with current id...
  my.resize = function() {
    var id, dataindex, dataObj, thisdata, results;
    id = my.localflags.currentconstit;
    dataindex = my.localflags.dataindex;
    if (dataindex === "sev") {
      // dataObj is from the external data file
      dataObj = model.data.singleResults2017;
      // results is a 'basic' results object in the model
      results = model.results2017;
    } else if (dataindex === "fif") {
      dataObj = model.data.singleResults2015;
      results = model.results2015;
    } else if (dataindex === "ten") {
      dataObj = model.data.singleResults2010;
      results = model.results2010;
    } else {
      dataObj = model.data.resultsBrexitObj;
      results = model.resultsBrexit;
    }
    // If we launched on a small device, this will error.
    // Obvz there's a proper fix, but for now... kludge.
    if (typeof dataObj === 'undefined') {
      return;
    }
    if (typeof id === 'undefined') {
      // Seats count
        thisdata = results;
    }
    else {
      // One result
      thisdata = dataObj[id];
    }
    // Update with the data object, the 'key', and a constit id (if any)
    updateTreeMap(thisdata, dataindex, id);
    // updateConstitInfo(data);
  };
  // RESIZE ends

  // UPDATE
  my.update = function() {
    var currentconstit, constitavailable, changed, data, dataindex, defaultText,
      updatecounter;
    constitavailable = modelFlags.constitavailable;
    currentconstit = modelFlags.currentconstit;
    dataindex = modelFlags.dataindex; // i.e. index of current tab
    updatecounter = modelFlags.updatecounter;
    // When the datafilter responds to the map's request to find data for 1 constit
    // (either loaded from file, or available in model.data)...
    // If there IS a constit id (ie we're not looking for a national seat count),
    // and if the datafilter set the not-available flag, bale out now.
    if ( (currentconstit !== undefined) &&
         (!constitavailable) ) {
      showUndeclared(currentconstit);
      return;
    }

    // Still here? OK...
    d3.select(".ukelmap-treechart")
      .transition().duration(500)
      .style("opacity", 1);

    // So if we're still here, there's an available constit to process
    changed = false;
    if (  (my.localflags.currentconstit !== currentconstit) ||
          (my.localflags.dataindex !== dataindex) ||
          (my.localflags.updatecounter !== updatecounter) ) {
      changed = true;
    }
    //
    if (changed) {
      if (currentconstit !== undefined) {
        if (dataindex === "sev") {
          data = model.data.singleResults2017[currentconstit];
          // Update treemap for new constit
          updateTreeMap(data, dataindex, currentconstit);
          // Update constit details
          updateConstitInfo(data, dataindex, currentconstit);
        } else if (dataindex === "fif") {
          data = model.data.singleResults2015[currentconstit];
          // Update treemap for new constit
          updateTreeMap(data, dataindex, currentconstit);
          // Update constit details
          updateConstitInfo(data, dataindex, currentconstit);
        } else if (dataindex === "ten") {
          data = model.data.singleResults2010[currentconstit];
          // Update treemap for new constit
          updateTreeMap(data, dataindex, currentconstit);
          // Update constit details
          updateConstitInfo(data, dataindex, currentconstit);
        }
        else {
          // Brexit
          data = model.data.resultsBrexitObj[currentconstit];
          // Update treemap for new constit
          updateTreeMap(data, dataindex, currentconstit);
          // Update constit details, using 2015 result...
          updateConstitInfo(model.data.singleResults2015[currentconstit], dataindex, currentconstit);
        }
        mnv_ukelmap.framework.viewConstituency( true );
        d3.select(".ukelmap-treetext-bottom").text("")
      }
      else {
        // currentconstit === undefined, so we're
        if (dataindex === "sev") {
          data = model.results2017;
        } else if (dataindex === "fif") {
          data = model.results2015;
        } else if (dataindex === "ten") {
          data = model.results2010;
        } else {
          data = model.resultsBrexit;
        }
        // "Seats": update tree map only
        // (CSS shows default text)
        updateTreeMap(data, dataindex);
        if (dataindex === "brx") {
          d3.select(".ukelmap-treetext-bottom").text("National result");
          defaultText = model.strings.brexitText;
        }
        else {
          d3.select(".ukelmap-treetext-bottom").text("UK total");
          defaultText = model.strings.defaultText;
        }
      }
      // Set the explanatory text
      d3.select(".default-body").html(defaultText);

      my.localflags.currentconstit = currentconstit;
      my.localflags.dataindex = dataindex;
      my.localflags.updatecounter = updatecounter;
    }
    // if changed ends
  };
  // UPDATE ends

  function makeTreeDataObj(data, key) {
    var conID, children, p, val, temp, lookup, total;
    lookup = model.data.constituencyLookupObj[data.id];
    tree = {
      id: data.id,
      //name: data.constituency_name,
      // name: lookup.name,
      name: function() {
        if (!lookup === undefined) { return lookup.name; }
      },
      children:[]
    };
    // Loop thro parties defined in model
    total = 0;
    for (p in parties) {
      if (parties.hasOwnProperty(p)) {
        val = parseInt(data[p]);
        if (!isNaN(val)) {
          temp = {};
          temp.id = p;
          temp.value = val;
          total += val;
          tree.children.push(temp);
        }
      }
    }
    // 2017 general: append 'undeclared'
    if ( (modelFlags.dataindex === "sev") &&
       (modelFlags.currentconstit === undefined) ) {
      temp = {};
      temp.id = "undeclared";
      temp.value = 650 - total;
      tree.children.push(temp);
    }
    return tree;
  }

  // UPDATE BREXIT TREEMAP
  // Called from my.update
  function updateB_exitTreeMap(data) {
    var sizes, tree, kids, kLen, maj, turnout, hpercent, wpercent;
    alert('Called updateB_exitTreeMap');
    if (data === undefined) { return; }

    wpercent = parseInt(treeWrapper.style("width"),10);
    hpercent = parseInt(treeWrapper.style("height"),10);
    sizes = mnv_ukelmap.utilities.recursiveParentSizeSearch(treeWrapper.node(),2);
    if (sizes !== undefined) {
      treeWidth = sizes.width - 20;
      treeHeight = sizes.height / 3;
    }
    else {
      treeWidth = 350;
      treeHeight = 185;
    }

    treeMap.size([treeWidth,treeHeight]);

    // Convert to treemap-compatible data object
    // Incoming 'data' is an object with a single property:
    // remain vote, as 'val'
    // I want an object with a 'children' property > remain/leave
    tree = {
      children: {
        remain: data.val,
        leave: 100 - data.val
      }
    }

  }
  // UPDATE BREXIT TREEMAP ENDS

  // UPDATE TREEMAP
  function updateTreeMap(data, key, constitID) {
    var sizes, tree, kids, kLen, maj, turnout, hpercent, wpercent, mapTree, majorityTree, itemisedData;

    if (data === undefined) { return; }

    wpercent = parseInt(treeWrapper.style("width"),10);
    hpercent = parseInt(treeWrapper.style("height"),10);
    sizes = mnv_ukelmap.utilities.recursiveParentSizeSearch(treeWrapper.node(),2);
    if (sizes !== undefined) {
      treeWidth = sizes.width - 20;
      treeHeight = sizes.height / 3;
    }
    else {
      treeWidth = 350;
      treeHeight = 185;
    }

    treeMap.size([treeWidth,treeHeight]);

    // Convert to treemap-compatible data object
    if (key === "brx") {
      var remainVal = data.val.toFixed(1);
      var leaveVal = (100 - remainVal).toFixed(1);
      mapTree = {
        children: [
          {id: 'remain', value: remainVal},
          {id: 'leave', value: leaveVal}
        ]
      };
      // And fetch in 2015 data
      if (typeof constitID === 'undefined') {
        itemisedData = model.results2015;
      } else {
        itemisedData = model.data.singleResults2015[constitID];
      }
    } else {
      itemisedData = data;
    }
    majorityTree = makeTreeDataObj(itemisedData, key)

    // This is a bit cheeky, but...
    // tree.children is an array of party votes only
    // So sort and use it to fill the majority span:
    kids = majorityTree.children.sort(function(a,b) {
      return a.value - b.value;
      });
    kLen = kids.length - 1;
    if (kLen > 0) {
      maj = kids[kLen].value - kids[kLen-1].value;
    }
    else {
      // Only one result!!!
      maj = kids[0].value;
    }
    maj = numberformat(maj);
    majorityvalues.text(maj);

    // Overall turnout, from original data obj:
    turnout = itemisedData.turnout;

    // Kill current content:
    d3.selectAll(".ukelmap-treemap-node").remove();

    // Now switch around to get the right data for the actual treeMap
    if (key !== 'brx') {
      mapTree = majorityTree;
    }

    // employees.sort(function(a, b){
    //     var nameA=a.name.toLowerCase(), nameB=b.name.toLowerCase()
    //     if (nameA < nameB) //sort string ascending
    //         return -1
    //     if (nameA > nameB)
    //         return 1
    //     return 0 //default return value (no sorting)
    // })

    // Sorting...
    // Brexit forces "Leave", "Remain"
    // Others sort by value
    treeMap.sort(function(a,b) {
      if (key === 'brx') {
        if (a.id < b.id) { return -1 }
        if (a.id > b.id) { return 1 }
        return 0;
      } else {
        return a.value - b.value;
      }
    });

    // Bind data
    node = treeMapDiv.datum(mapTree).selectAll(".node")
      .data(treeMap.nodes)
    ;

    // Enter
    node.enter().append("div")
      .attr("class", "ukelmap-treemap-node")
    ;
    // Update
    node
      //.data(treeMap.nodes)
      // .transition().duration(500)
      .call(position)
      .style("background-color", function(d, i) {
        var col;
        // Node 0 is the background, so white:
        if (i === 0) {
          col = "#ffffff";
        }
        else {
          // Defined colour?
          col = model.colours[d.id];
          // if (d.id === "undeclared") {
          //   col = model.colours.undeclared;
          // } else if (d.id === "remain") {
          //   col = model.colours.undeclared;
          // }
          if (typeof col === 'undefined') {
            col = parties[d.id].colour;
          }
        }
        return col;
      })
      .attr("datatooltip", function(d, i){
        var result;
        if (d.id === "undeclared") {
            result = "Undeclared: " + d.value + " seats";
        }
        else if (d.id === 'remain') {
          result = "Remain: " + d.value + "%";
        } else if (d.id === 'leave') {
          result = "Leave: " + d.value + "%";
        }
        else if (i > 0) {
          if (turnout !== undefined) {
            result = model.parties[d.id].midname + ": " + (d.value / turnout * 100).toFixed(1) + "%";
          }
          else {
            result = model.parties[d.id].midname + ": " + d.value + " seats";
          }
        } else {
          result = '';
        }
        return result;
      })
      .text(function(d, i) {
        var result;
        if (i > 0) {
          if ( (d.dx > 40) && (d.dy > 20) ) {
            if (d.id === 'remain') {
              result = "Remain: " + d.value + "%";
            } else if (d.id === 'leave') {
              result = "Leave: " + d.value + "%";
            } else if (turnout !== undefined) {
              result = (d.value / turnout * 100).toFixed(1) + "%";
            }
            else {
              result = d.value + " seats";
            }
          }
        }
        return result;
      })
      ;
    // Update on text sub-div
    // (separated to isolate from the transition on the node div)
    /*
    node
      .append('div')
      .attr("class")
      .style("font-size", function(d) {
          // compute font size based on sqrt(area)
          //return Math.max(20, 0.18*Math.sqrt(d.area))+'px'; })
          return Math.max(15, 0.1*Math.sqrt(d.area))+'px'; })
      .text(function(d) {
        var id, pName, partyTurnout;
        partyTurnout = d.value / turnout * 100;
        //id = d.id;
        pName = null; // by default
        // If node has no children (ie is a party value)
        if (!d.children) {
          // pName = parties[id].shortname;
          return partyTurnout.toFixed(1) + "%";
        }
        //return pName;
      })
      */
    ;

    // Exit
    node
      .exit()
      .attr("test", function() {
      })
      .remove();
  }
  // UPDATE TREEMAP ENDS

  // UPDATE CONSTIT INFO
  // Displays constituency details
  function updateConstitInfo(data, key) {
    var id, winner, winStr, winCol, statusStr, mpVotes, vPercent, tuStr,
      swingLab, swingVal;

    if (data === undefined) { return; }

    // Do any workings...
    winStr = parties[data.win].midname;
    winCol = parties[data.win].colour;
    // Status (gain/hold); if undefined, blank
    statusStr = data.status;
    if (statusStr === undefined) {
      statusStr = ""
    }
    // Winner's votes and % of votes
    mpVotes = data[data.win];
    vPercent = mpVotes / data.turnout * 100;
    mpVotes = numberformat(mpVotes);
    mpVotes += " (" + vPercent.toFixed(1) + "%)";
    // Swing
    swingLab = "Swing";
    swingVal = data.swing;
    if (swingVal === undefined) {
      swingLab = "";
      swingVal = "";
    }
    else {
      swingVal += "%";
    }

    // Turnout as number and % of population
    tuStr = numberformat(data.turnout);
    tuStr += " (" + (data.turnout / data.electorate * 100).toFixed(1) + "%)";
    // Now slam everything into the elements:
    region.text(data.region);
    //constituency.text(data.constituency_name);
    constituency.text(model.data.constituencyLookupObj[data.id].name);
    partyname
      .text(winStr)
      .style("color",winCol)
      ;
    // partystatus.text(statusStr);
    // NOTE: until we know what we're doing with 2017 data, this string
    // (which is welded into 2015 data) foreced to empty
    partystatus.text('');
    mpname
      .text(data.mpn)
      .style("color",winCol);
    mpvalues.text(mpVotes);
    majoritylabel.text("Majority");
    swinglabel.text(swingLab);
    swingvalues.text(swingVal);
    turnoutlabel.text("Turnout");
    turnoutvalues.text(tuStr);
    // NOTE: majority is done by updateTreemap, where we have a sort...

  }
  // UPDATE CONSTIT INFO ends


  // SHOW UNDECLARED
  // Hide treemap and show undeclared details
  function showUndeclared(id) {
    d3.select(".ukelmap-treechart")
      .transition().duration(500)
      .style("opacity", 0);
    mnv_ukelmap.framework.viewConstituency(true);
    d3.select(".ukelmap-treetext-bottom").text("");
    region.text("Not declared");
    constituency.text(model.data.constituencyLookupObj[id].name);
    partyname.text("");
    partystatus.text("");
    mpname.text("");
    mpvalues.text("");
    majoritylabel.text("");
    majorityvalues.text("");
    swinglabel.text("");
    swingvalues.text("");
    turnoutlabel.text("");
    turnoutvalues.text("");
    // Kludge forces local flag off, so that on a tab change my.update
    // registers the incoming constit id as a change...
    my.localflags.currentconstit = undefined;
  }

  // ************ Below is specific to the demographics column chart ***************

  // DRAW COL CHART
  // Param is data array for this constit. 2 elements with
  // display and value properties
  function drawColChart(data) {
    var topicID, demographics, enter, min, max, needUpdateYAxis, valOffset = 5,
      getY, noVal = false;

    // On the mobile version, the colChart doesn't get initted (because
    // containing wrappers have no size). In that case, we've returned from
    // initColChart before the svg element colChartSVG was created.
    // So abort if it doesn't exist:
    if (colChartSVG === undefined) { return; }

    // Update axis if topic is changed
    needUpdateYAxis = (topicID!==model.flags.dataindex);

    topicID = model.flags.dataindex;
    demographics = model.demographics[topicID];

    // DOMAINS
    colChartxScale
      .domain(data.map(function(d) {
        return d.display;
      }))
      ;
    min = demographics.min;
    max = demographics.max;
    colChartyScale
      .domain([min,max])
      ;

    cluster = colChartGroup.selectAll(".cluster")
      .data(data);

    getY = function(d) { return d.value < 0 ? colChartyScale(0) : colChartyScale(d.value); };

    cluster.each(function(d, i) {
      var it, val, label, col;
      var _d = d;
      var _i = i;
      it = d3.select(this);
      // Rect
      col = it.selectAll("rect")
        .transition().duration(750)
        .attr({
          //"x": my.col_x(_d,_i),
          "x": function(_d) {
            return my.col_x(_d); },
          "width": function() { return colChartxScale.rangeBand(); },
          "y": function(d, i) { return getY(_d); },
          "height": function(d, i) { return Math.abs( colChartyScale(_d.value) - colChartyScale(0) ); }
        })
        .style("fill", function(){
          return my.col_fill(_d, _i);
          })
        ;

      // Value
      val = it.selectAll(".ukel-val-text")
        .transition().duration(750)
        .attr({
          // "x": my.col_x(_d,_i),
          "x": function(d) { return my.col_x(d)},
          "y": function() { return getY(_d) - valOffset}
        })
        .text(d.valStr)
        ;
      // Category
      label = it.selectAll(".ukel-cat-text-p")
        .text(function() { return d.display; });

    });

    // Enter
    enter = cluster.enter().append("g")
      .attr("class","cluster")
      ;

    // THERE'S SOME REDUNDANCY HERE: I CAN DO A LOT OF WHAT THE ENTER DOES IN THE UPDATE, ABOVE...
    var colWidth = function() { return colChartxScale.rangeBand(); };

    // Rect
    enter.append("rect")
      .attr({
        "class": "col-rect",
        // X pos and width:
        "x": function(d) {
          return my.col_x(d)},
        "width": colWidth(),
        "y": function(d, i) {
          return getY(d); },
        "height": function(d, i) { return Math.abs( colChartyScale(d.value) - colChartyScale(0) ); }
      })
      .style("fill", function(d, i){
        return my.col_fill(d, i);
      })
    ;

    // Category string
    var colsI = 0;
    enter.append("foreignObject")
      .attr({
        //"y": function(d, i) { return getY(d) - labelOffset; },
        "y": svgH + 5,
        "x": function(d){
          //var x = colsI *  (my.col_x()*2 + colWidth());
          // var x = colsI *  (colChartxScale(d.display)*2 + colWidth());
          // colsI++;
          // return x;
          return my.col_x(d);
        },
        "dy": ".15em",
        "height": 100,
        // Width is a bit of a hack to force alignment:
        "width": colWidth() * 0.9,
        "class": function(d, i){
          return "ukel-cat-text ukel-cat-" + ((i===0) ? "cons" : "nat");
        }})
        .append("xhtml:body")
        .attr("xmlns","http://www.w3.org/1999/xhtml")
        .append("div")
        .append("p")
        .attr("class","ukel-cat-text-p")
        .text(function(d){
          return d.display;
        });
        // .attr("class", "ukel-cat-text-div")
        // .text(function(d) { return d.display; })

    // Value text:
    enter.append("text")
      .attr({
        "y": function(d, i) { return getY(d) - valOffset; },
        "x": my.text_x,
        "dy": ".15em",
        "class": function(d, i){
          return "ukel-val-text ukel-val-" + ((i===0) ? "cons" : "nat");
          }
        })
        .text(function(d) { return d.valStr; })
        /*
        .text(function(d) {
          var s;
          if (d.display.length > 0) {
            s = d3.round(d.value, nrOfDecimal);
          }
          else {
            s = "";
          }
          return s;
        })
        */
        ;

    if(needUpdateYAxis){
      // Update Y axis
      colChartSVG
        .transition()
        .select(".y-axis") // change the y axis
              .duration(750)
              .call(yAxis);
      // ...snd zero line
      zeroline
        .transition().duration(750)
        .attr('x1', 0)
        .attr('y1', colChartyScale(0))
        .attr('x2', svgW)
        .attr('y2', colChartyScale(0));
    }
    // // Not that it should be needed...
    // cluster.exit()
    //   .style("opacity", 1)
    //   .transition()
    //     .duration(300)
    //     .style("opacity", 0)
    //     .remove()
    //   ;
  }

  // INIT COL CHART
  // Param is wrapper
  function initColChart(wrapper) {
    var margin, sizes;
    // Set our margins
    margin = {
      top: 10,
      right: 0,
      bottom: 80,
      left: 30
    }

    // Try to detect w and h from the wrapper
    sizes = wrapper.node().getBoundingClientRect();
    if(sizes.width!==0 && sizes.width){
     svgH = sizes.height;
     svgW = sizes.width;
    }
    else {
      // Try to detect sizes from parent element
      sizes = mnv_ukelmap.utilities.recursiveParentSizeSearch(wrapper.node());
      // Set default width
      //if(!sizes){
      if(sizes !== undefined){
        svgH = 300;
        svgW = 250;
      }
    }
    svgW = svgW - margin.left - margin.right,
    svgH = svgH - margin.top - margin.bottom;
    colChartSVG = wrapper.append("svg")
      .attr("width", svgW + margin.left + margin.right)
      .attr("height", svgH + margin.top + margin.bottom)
      ;

    colChartGroup = colChartSVG
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    colChartxScale = d3.scale.ordinal()
      .rangeBands([0,svgW], 0.2, 0)
      ;

    colChartyScale = d3.scale.linear()
      .range([svgH,0])
      ;

    yAxis = d3.svg.axis()
      .scale(colChartyScale)
      .orient("left")
      .ticks(5)
      .tickSize(-svgW,0)
      ;

    colChartGroup.append("g")
      .attr("class","y-axis")
      .call(yAxis);

    // Zero line
    zeroline = colChartGroup
      .append('line')
      .attr('x1', 0)
      .attr('y1', colChartyScale(0))
      .attr('x2', svgW)
      .attr('y2', colChartyScale(0))
      .attr("class","zero-line")
      .style("stroke-width",1)
      ;
  }
  // INIT COL CHART ends

  // Column chart functions:
  // x-pos of columns
  my.col_x = function(d, i) {
    var it = colChartxScale(d.display);
    return colChartxScale(d.display);
  };
  // TEXT_X returns text x-pos
  my.text_x = function(d, i) { return colChartxScale(d.display); };
  my.cluster_w = function(d, i) {
    //colChartxScale(i)
    return  colChartxScale.rangeBand();
  }
  // Height and fill functions
  my.col_height = function(d) {
    //return colChartyScale(+d.value) - colChartyScale(0);
    return svgH - colChartyScale(+d.value);
  };
  my.col_fill = function(d, i){
    var sel = (i === 0) ? "cons" : "nat";
    return model.demographics[model.flags.dataindex].fill[sel];
  }

  return my;
}());
// TREE MAP ends

function ecLiveSearch(config){
  'use strict';
  var widget, inputField, resultsList, widgetClassName = "mnv-ec-livesearch", search, trigger, hideResults, bindEvents, container, hideOnLeave, log, list, searchProperty, prefix, timer, hideTimer, reset, hasClass, resetForm;
  prefix = widgetClassName + "-";
  this.init = function(config) {
    if(config.list instanceof Array === false) {
      log("list should be an array");
      return false;
    }
    if(config.list.length === 0) {
      log("list shouldn't be empty");
      return false;
    }
    if(config.searchProperty === undefined) {
      log("Provide a searchProperty");
      return false;
    }
    if(config.searchProperty === undefined) {
      log("Provide a searchProperty");
      return false;
    }
    container = document.querySelectorAll('.' + widgetClassName);
    if(container.length===0){
      log('Unable to find a widget with class ' + widgetClassName);
      return false;
    }
    if(config.caseInsensitive === undefined){
      config.caseInsensitive = true;
    }
    container = container[0];
    list = config.list;
    searchProperty = config.searchProperty;
    hideOnLeave = config.hideOnLeave || false;
    inputField = document.createElement('input');
    inputField.className = prefix + "input";
    inputField.setAttribute('placeholder', config.placeholder );
    reset = document.createElement('button');
    reset.className = prefix + "reset search";
    reset.innerText = '';
    resultsList = document.createElement('ul');
    resultsList.className = prefix + "list";
    resultsList.style.display = 'block';
    container.appendChild(inputField);
    container.appendChild(reset);
    container.appendChild(resultsList);
    bindEvents();
  };

  search = function(str){
    var results, items;
    log('Starting search');
    resultsList.style.display = 'block';
    resultsList.innerHTML = '';
    var ar = str.split(" ");
    var reg = '';
    ar.map(function(val){
      reg += '(?=.*' + val + ')';
    });
    if(str.trim()===""){
      results = [];
    } else {

      var re = new RegExp(reg, (config.caseInsensitive) ? 'i' : null );
      results = list.filter(function(value){
        return value[searchProperty].match(re);
      });
    }
    if(results.length===0){
      resultsList.innerHTML = '<li>No results</li>';
    } else {
      items = [];
      results.map(function(obj){
        var item = document.createElement('li');
        item.innerHTML = obj[searchProperty];
        item.addEventListener('click', function(){
          inputField.value = obj[searchProperty];
          trigger.call(container, 'resultSelected', obj);
          hideResults(false);
        });
        resultsList.appendChild(item);
      });
    }
  };

  trigger = function(ev, data){
    var myEvent;
    function noCustomEvent(ev, data){
      var myEvent = document.createEvent('CustomEvent');
      myEvent.initCustomEvent(ev, true, true, data);
      return myEvent;
    }
    if (window.CustomEvent) {
      try {
        myEvent = new CustomEvent(ev, {
          detail: data
        });
      }
      catch (e){
        myEvent = noCustomEvent(ev, data);
      }
    } else {
      myEvent = noCustomEvent(ev, data);
    }
    log('triggered: ' + ev + ' with data : ' + data);
    this.dispatchEvent(myEvent);
  };

  log = function(txt){
    if(window.console && window.console.log){
      console.log(txt);
    }
  };

  hideResults = function(resetInput){
    if(resetInput===true){
      resetForm();
    }
    resultsList.innerHTML = "";
    resultsList.style.display = 'none';
  };

  hasClass = function(el, className){
    return (el.classList) ? el.classList.contains(className) : new RegExp('(^| )' + className + '( |$)', 'gi').test(el.className);
  };

  resetForm = function(){
    inputField.value = '';
    reset.className = prefix + "reset search";
    trigger.call(container, 'fieldReset');
  };

  bindEvents = function(){
    inputField.addEventListener('keyup', function(){
      var str =  this.value.trim();
      if(hasClass(reset, 'search')){
        reset.className = prefix + "reset close";
      }
      clearTimeout(timer);
      timer = window.setTimeout(function() {
        search(str);
      }, 500);
    });
    inputField.addEventListener('focus', function(){
      resetForm();
    });
    if(hideOnLeave){
      resultsList.addEventListener('mouseleave', function(){
        clearTimeout(hideTimer);
        hideTimer = window.setTimeout(function() {
          hideResults();
        }, 1000);
      });
    }
    reset.addEventListener('click', function(){
      if(hasClass(this, "search")){
        // Focuse on magnifier click
        inputField.focus();
      } else {
        hideResults(true);
      }
    });
  };

  if(!config){
    log("You have to provide a config object");
    return false;
  }
  this.init(config);
}

var mnv_ukelmapTagConfig = {
  elements: '.mnv-map-uk-election-2017-election-night',
  url: mnv_ukelmap.model.sourcefiles.results2017,
  callbackName: 'seatsAndWinners2017CB',
  pollingTime: 10000
};
MnvDRSI.subscribe(mnv_ukelmapTagConfig);

// I've set pollingTime to 10secs, which is Umbi's minimum...

$(document).ready(function(){
  'use strict';
  mnv_ukelmap.controller.initFramework();
});
